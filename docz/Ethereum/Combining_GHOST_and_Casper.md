# 结合 GHOST 与 Casper

Vitalik Buterin

以太坊基金会

v@buterin.com

Diego Hernandez

圣何塞州立大学

diego.hernandez@sjsu.edu

Thor Kamphefner

圣何塞州立大学

thor.kamphefner@sjsu.edu

Khiem Pham

VinAI Research

v.khiempdi@vinai.io

Zhi Qiao

圣何塞州立大学

qiaozhi9092@gmail.com

Danny Ryan

以太坊基金会

danny@ethereum.org

Julyeok Sin

圣何塞州立大学

homin203@gmail.com

Ying Wang

圣何塞州立大学

yingwang1001@gmail.com

Yan X Zhang

圣何塞州立大学

yan.x.zhang@sjsu.edu

###### 摘要

我们提出了“Gasper”，一个基于权益证明的共识协议，它是拟议的以太坊2.0信标链的理想化版本。该协议结合了最终性工具 Casper FFG 和分叉选择规则 LMD GHOST。我们在不同的假设集下证明了其安全性、合理活跃性及概率活跃性。

###### 目录

* 1 引言

* 2 设置与目标 * 2.1 共识协议、验证者、区块链 * 2.2 消息与视图 * 2.3 权益证明 * 2.4 拜占庭验证者、PBFT * 2.5 安全性与活跃性 * 2.6 时间、时段与同步性

* 3 主要组成部分 * 3.1 Casper FFG * 3.2 LMD GHOST 分叉选择规则

## 4 主协议：Gasper

### 时段边界区块与配对
### 委员会
### 区块与证明
### 合理化
### 最终确定
### 混合 LMD GHOST
### 罚没条件
### 奖励与惩罚

## 5 安全性

## 6 合理活跃性

## 7 概率活跃性

### 首个时隙后的高权重 - 模棱两可游戏
### 首个时隙后的高权重导致合理化
### 概率合理化导致概率最终确定

## 8 实践与理论

### 分片
### 视图的实现
### 证明包含延迟
### 证明考虑延迟
### 四案例最终确定规则
### 安全性 - 动态验证者集合
### 极端情况；硬分叉

## 9 结论

## 附录 A 视图的技术细节

## 附录 B 模棱两可游戏

### 悲观体制 - 高延迟
### 乐观体制 - 低延迟
### 中间示例

## 1 引言

我们的目标是创建一个用于权益证明区块链的共识协议。本文的动机源于在分片设计中构建以太坊“信标链”的需求。然而，该构建也可用于无需分片的独立区块链。

我们提出了 Gasper，它结合了 Casper FFG（友好最终性小工具）和 LMD GHOST（最新消息驱动最贪婪最重观察子树）。Casper FFG [7] 是一个“最终性小工具”，它是一种算法，用于将区块链中的某些区块标记为*最终确定*，使得信息不完全的参与者仍然可以完全确信这些区块是规范区块链的一部分。Casper 并非一个完全指定的协议，被设计为一个“小工具”，工作在所提供的区块链协议之上，不关心所提供的链是工作量证明还是权益证明。LMD GHOST 是一个*分叉选择规则*，其中*验证者*（参与者）对区块进行*证明*以表示对这些区块的支持，类似于投票。Gasper 是一个完整的权益证明协议，是拟议的以太坊实现的理想化抽象。

在第 2 和第 3 节，我们定义了我们的基础概念，提供了背景知识，并阐述了我们的目标。在第 4 节，我们给出了我们的主协议 Gasper。在第 5、6 和 7 节，我们正式证明了 Gasper 的期望特性。在第 8 节，我们总结了 Gasper 与实际规划的以太坊实现之间的一些差异，例如接受证明的延迟、最终确定的延迟以及动态验证者集合。我们在第 9 节以对未来研究的一些思考和想法作为结论。

## 2 设置与目标

本文的主要目标是描述并证明一个具有特定安全性和活跃性声明的权益证明区块链的特性。在本节中，我们提供一些关于共识协议和区块链的一般背景。由于文献中使用多样化的词汇，本节的主要目的是为本文的其余部分挑选一套特定的词汇。

### 2.1 共识协议、验证者、区块链

我们的目标是创建一个*共识协议*（或简称*协议*），这是一套商定的算法，供一组实体（节点、人等）遵循，以获得其状态的共识历史，即使网络不可靠和/或许多验证者是恶意的。

我们称参与协议的实体（人、程序等）为*验证者*，用集合 $\mathcal{V}$ 表示。它们之所以被称为“验证者”，是因为它们在以太坊 2.0 信标链中的数据验证角色，尽管该角色的具体细节不是我们抽象协议的一部分。其他著作对同一概念使用了许多不同的词语：例如，经典 PBFT 文献中的“副本”、DPoS 和 EOS 中的“区块生产者”、Peercoin 和 Nxt 上的“对等节点”，或 Tezos 上的“烘焙师”。验证者通过一个（点对点）*网络*相互连接，这意味着它们可以相互广播*消息*（基本上是数据包）。在我们感兴趣的类型协议中，主要类型的消息是*区块*，它收集消息的集合。第一个区块称为*创世区块*，充当初始的“空白”状态。其他区块是带有指向*父*区块1指针的状态转换描述。*区块链*只是这种共识协议的一个实例化（即具有特定的网络条件、验证者等），其中我们使用区块来构建整体状态。

Footnote 1: 我们选择每个区块有一个唯一的父区块在区块链中几乎是理所当然的；人们可以想象区块不需要有父区块，或者可以有多个父区块的区块链。例如，参见 Hashgraph [2]。甚至“区块”本身的非常通用的结构也可能是限制性的！

我们并不希望网络上看到的所有区块都被接受为共同历史，因为区块可能相互冲突。这些冲突可能由于诚实的原因（如网络延迟）或恶意的原因（如希望双花的拜占庭验证者）而发生。*拜占庭*指的是分布式系统中的一个经典问题，即拜占庭将军问题，在这种情况下用来描述不遵循协议的验证者，无论是因为他们是恶意的还是正在经历网络延迟。从图论上讲，可以将对历史的选择视为选择一条从创世区块到特定区块的“链”。因此，共识历史是

### 2.2 消息与视图

在我们的模型中，验证者 $V$ 通过广播*消息*与网络交互，消息是某种语言中的字符串。当诚实的验证者 $V$ 广播消息 $M$ 时，我们假设 $M$ 被发送到网络上的所有验证者2。

Footnote 2: 我们将验证者建模为向抽象的“网络”发送单一消息，由该网络处理消息。在实践中，协议可能规定例如每个诚实验证者重新广播他们看到的所有消息，以保证鲁棒性。我们认为这些实现细节对我们的论文不重要。

消息的主要类型是向网络*提议*一个*区块*，即一段数据。其他消息可以是簿记通知，例如为区块投票（“证明”）、将新验证者加入区块链（“激活”）、证明其他验证者的不良行为（“罚没”）等，具体取决于特定协议。我们假设每条消息都由单个验证者进行数字签名，这意味着我们可以准确追踪每条消息的作者，并且诸如冒充诚实验证者的攻击是不可能的。

由于网络延迟和不诚实的验证者（延迟消息或转发错误信息），验证者可能对提供给网络的完整消息集有不同的知识状态；我们通过说验证者在任何给定时间*看到*或*未看到*网络上的每条消息来形式化这一点。

每条消息可能有一个或多个*依赖项*，其中每个依赖项是另一条消息。在任何时候，当且仅当其所有依赖项（可能没有）被接受时，我们才*接受*一条消息，这是递归定义的。我们现在将给定时间 $T$ 的验证者 $V$ 的*视图*定义为 view$(V,T)$，即验证者到目前为止看到的所有**已接受**消息的集合。我们还有一个“上帝视角”，称之为*网络视图*，定义为一个假设的验证者（无延迟地）看到任何验证者在任何时间广播的所有消息（包括恶意验证者仅向网络子集发送的消息）的已接受消息集合。我们将网络视为一个“虚拟验证者”，因此使用 view$(\mathsf{NW},T)$ 表示时间 $T$ 的网络视图。对于任何验证者 $V$ 和任何给定时间 $T$，view$(\mathsf{NW},T)$ 包含 view$(V,T)$ 中的所有消息，尽管时间戳可能不匹配。最后，由于通常上下文是我们谈论的是特定的时间点，我们通常会抑制时间，使用诸如 view$(V)$ 这样的符号来谈论 view$(V,T)$，除非谈论特定时间是必要的。

**示例 2.2** 在时间 $T$，假设验证者 $V$ 看到消息 $M$，内容为“Yunice 将编号为 $5340$ 的币发送给 Bob”，但尚未看到包含“Yunice 获得编号为 $5340$ 的币”的消息 $M^{\prime}$（该消息在网络中但尚未到达 $V$）。还假设在我们的协议中，$M$ 依赖于 $M^{\prime}$（且不依赖于其他消息），这捕捉了在花费币之前需要获得币的语义含义，并且 $V$ 在没有看到 $M^{\prime}$ 的情况下不能也不应该对 $M$ 采取行动。在这种情况下，我们说 $V$ 已看到但尚未接受 $M$，因此 $M\notin \textrm{view}(V,T)$。然而，网络两者都已看到；因此，如果网络接受 $M^{\prime}$，我们有 $M\in \textrm{view}(\mathsf{NW},T)$。

我们现在对视图的结构做一些假设：

* 每个人（验证者和网络）都以一条对应于商定的单一*创世区块*的消息（无签名）开始，记为 $B_{\textrm{genesis}}$，没有依赖项（因此它自动被所有视图接受）。
* 除了 $B_{\text{genesis}}$ 之外的每个区块，在其数据中引用（并依赖于）一个*父区块*。因此，我们可以将 view$(V)$ 可视化为一个有向无环图（实际上是有向树3），根为 $B_{\text{genesis}}$，如果 $B$ 是 $B^{\prime}$ 的父区块，则存在边 $B\gets B^{\prime}$，在这种情况下，我们说 $B^{\prime}$ 是 $B$ 的一个*子*区块。我们称这些为*父子*边，以区别于其他类型的边。 Footnote 3: 这个陈述已经捕捉了我们定义“看到”和“接受”的主要原因；验证者*接受*的区块必须是一棵单根树，尽管验证者*看到*的区块可以是该树的某个任意子集，因此将我们的注意力限制在树上可以允许更清晰的分析并避免病态情况。除此之外，这两个词之间的区别在本文的其余部分并不重要。
* 如果一个区块没有子区块，我们称其为*叶*区块。
* 在这种协议中，一条*链*将是一系列成对的父子边 $B_{1}\gets B_{2}\leftarrow\cdots$。如果存在一条从 $B$ 到 $B^{\prime}$ 的链，我们说 $B^{\prime}$ 是 $B$ 的*后代*。当且仅当 $B^{\prime}$ 是 $B$ 的后代时，我们说 $B$ 是 $B^{\prime}$ 的*祖先*。如果两个区块 $B$ 和 $B^{\prime}$ 不相等且彼此不是后代，我们说它们*冲突*。
* 上述设置意味着每个区块 $B$ 唯一定义了一条从 $B_{\text{genesis}}$ 到 $B$ 的（向后）链，并且在任何包含 $B$ 的视图中，这必须是同一条链（因此我们不需要将视图作为其定义的一部分）。我们称此为*$B$ 的链*，或 chain$(B)$。

**示例 2.3** 参见图 1 中的视图示例，仅限于区块。箭头描绘父子边。视图中的区块形成一棵以单一创世区块 $B_{\text{genesis}}$ 为根的树。这里区块 $C$ 和 $D$ 冲突（以及 $E$ 和 $D$）。$E$ 具有最长的链，即 chain$(E)=(B_{\text{genesis}},A,B,C,E)$。

我们在本节的措辞中有一些技术细节，这些细节促使我们定义*视图*，但对本文的核心并不重要。为了不分散读者的注意力，我们将这些细节推迟到附录 A。

### 2.3 权益证明

区块链协议的第一个也是最具影响力的方法是比特币 [15]，它使用工作量证明模型。这种方法使得提议区块在计算上很困难，使用了简单直观的分叉选择规则“最重链的区块是链头”。矿工（验证者的类比）只是在最重的链（具有最多计算工作量的链）上提议构建区块，这在数学上不能保证任何非创世区块是“正确的”，但提供了概率保证，因为一旦其他矿工在其上构建，与之冲突的可能性就越来越小。然后共识历史就是工作量最重的链，理想情况下它会不断增长。工作量证明的优雅是以昂贵的计算工作/电力等成本来提议区块为代价的。

在本文中，我们希望创建一个*权益证明*区块链，其中验证者的投票权与其在系统中质押的权益（或金钱）成比例。提议区块不是使用计算能力，而是基本上是免费的。作为交换，我们需要额外的数学理论层来防止在使提议区块变得“容易”时出现的反常激励。我们现在将本文的重点转移到一类考虑权益证明的区块链设计上。

首先，我们假设我们有一个包含 $N$ 个*验证者*的集合 $\mathcal{V}=\{V_{1},\ldots,V_{N}\}$，并且每个验证者 $V\in \mathcal{V}$ 有一定数量的*权益* $w(V)$，一个正实数，描述抵押物的数量。我们进一步假设每个验证者的平均权益为 $1$ 单位，因此总权益之和为 $N$。我们所有涉及权益的操作都是线性的，因此这种缩放不会改变情况，并使簿记更容易。为了专注于协议的理论要点，我们假设验证者集合和权益规模是固定的。我们将在后面的章节，特别是第 8 节，讨论在实际使用中放宽这些条件时出现的问题。

我们需要的主要组成部分是：

*   一个*分叉选择规则*：一个函数 fork()，当给定一个视图 $G$ 时，识别出一个单一的叶区块 $B$。这个选择产生一条从 $B_{\text{genesis}}$ 到 $B$ 的唯一链 fork($G$) = chain($B$)，称为*规范链*。区块 $B$ 在视图 $G$ 中被称为*链头*。直观地说，分叉选择规则给验证者一个遵循的“法则”来决定“正确的”区块应该是什么。例如，*最长链规则*是一个分叉选择规则，它返回距离创世区块最远的叶区块。这个规则与比特币使用的“最重链规则”类似。
*   *最终性*的概念：形式上，一个确定性函数 $F$，当给定一个视图 $G$ 时，返回一个*最终确定*区块的集合 $F(G)$。直观地说，最终确定的区块是“每个人最终都会认为是共识历史一部分”或“区块链所确定的”区块。
*   *罚没条件*：这些是诚实验证者永远不会违反的条件，违反的验证者可以被明确抓住，其权益将被*罚没*或销毁。罚没条件激励验证者遵循协议（例如，协议可以奖励诚实验证者抓住违反条件的不诚实验证者）。

我们用来定义这些组成部分的关键概念是*证明*，它们是对哪些区块“应该”成为链头的投票（嵌入在消息中）。为了防止验证者重复投票或以破坏协议的方式投票，我们强制执行*罚没条件*，这些条件可用于销毁验证者的权益，从而激励验证者遵循协议。

人们可以在图 2 中看到我们将要呈现的协议的一个理想化版本；在每个时间段，创建一个新区块，其父区块是上一个链头（理想情况下就是上一个创建的区块），相应委员会中的所有验证者都完美地对新区块进行证明。在不太理想的情况下，区块可能会分叉，我们可能有缺失的证明等，证明将通过帮助验证者决定正确的链头来发挥作用。我们将在第 4 节定义所有细节。

### 2.4 拜占庭验证者，PBFT

在协议中，如果验证者遵循协议，我们称其为*诚实*的，否则为*拜占庭*的。我们通常假设严格少于 $p=\frac{1}{3}$ 的验证者是拜占庭的。这个常数可以追溯到 [8] 中的实用拜占庭容错（PBFT），这是拜占庭容错文献中的经典共识协议；PBFT 确保只要少于 $\frac{1}{3}$ 的*副本*（与我们的*验证者*同义）是拜占庭的，系统就能正确运行，如 [3] 所证明。这个 $\frac{1}{3}$ 的容错常数频繁出现在许多基于 PBFT 的工作中（主要思想是鸽巢原理论证需要 $1/3$ 才能成立，例如我们在第 5 节中的证明），其中 Casper FFG [7] 与我们的工作最直接相关，我们将在 3.1 节回顾。

具体来说，如果具有总计 $pN$ 权益的验证者可以被拥有网络视图的验证者明确罚没，我们定义运行该协议的区块链是*$p$-可罚没的*，并且我们的大多数结果将采用这种形式：“在任何时候，我们的区块链要么具有（良好）性质 X，要么是 $(1/3)$-可罚没的”，因为当我们有许多拜占庭行为者时，我们确实无法保证任何良好性质，所以这是我们能够拥有的最强类型的陈述。还要注意，拥有 $(1/3)$-可罚没性比仅仅拥有 $(1/3)$ 的权益属于拜占庭验证者是更强且更理想的结果，因为如果我们只有后者的保证，我们可能仍然会激励原本诚实的验证者以一种不被抓住的方式作弊。

PBFT 最重要的一个方面是它在*异步*条件下工作，这意味着我们对消息接收所需的时间没有限制。因此，它对区块链和加密货币的要求具有鲁棒性，我们经常担心对抗性环境。我们将在第 2.6 节进一步讨论同步性假设。

### 2.5 安全性与活跃性

诚实验证者的最终目标是增长一条最终确定的链，其中所有区块彼此形成“逻辑一致”的状态转换（尽管验证者可能离线、遇到延迟问题或恶意地提议冲突的状态更改）。形式上，这转化为两个期望的性质：

**定义 2.4** 我们说一个共识协议具有：

*   *安全性*，如果对于任何视图 $G$，最终确定区块的集合 $F(G)$ 永远不能包含两个冲突的区块。拥有安全性的一个结果是，任何验证者视图 $G$ 的最终确定区块 $F(G)$ 可以“补全”为从创世区块开始到最后一个最终确定区块结束的 $F(\text{view}(\text{NW}))$ 的唯一子链，我们称之为*最终确定链*。
*   *活跃性*，如果最终确定区块的集合实际上可以增长。定义活跃性有不同的方式。对于我们的论文，我们说该协议具有：
    *   *合理活跃性*，如果无论之前发生任何事件（攻击、延迟等），总是有可能最终确定新区块（换句话说，不可能“死锁”）。这是为了防止诚实验证者无法继续，除非有人自愿放弃自己的权益。
    *   *概率活跃性*，如果无论之前发生任何事件，很可能最终确定新区块（一旦我们对网络延迟、攻击者的能力等做出一些概率假设）。乍一看，后者意味着前者，但情况更微妙；前者是关于协议逻辑的纯粹非概率性质；后者需要（可能非常强的）关于实现环境的假设，以保证协议“通常按预期工作”。我们在第 7.3 节进一步讨论这种对比。本文的主要目标是在第 4 节中证明我们主协议的这些重要性质。

**备注**（语法与语义）。链与状态转换的逻辑一致性之间有关联，这不应该立即显而易见，这需要协议设计者做更多的工作来确保。例如，可以规定一个协议，允许用户花费币 $S$ 的区块禁止其祖先区块在另一笔交易中使用 $S$。在这种情况下，如果 Xander 从区块 $B_{x}$ 获得一个币 $S$ 并写入两个区块 $B_{y}$ 和 $B_{z}$，使得 $B_{y}$ 的数据包括 Xander 支付 $S$ 给 Yeezus，而 $B_{z}$ 的数据包括 Xander 支付 $S$ 给 Zachariah，那么这些行为在逻辑上不一致的想法对应于图论性质：$B_{y}$ 和 $B_{z}$ 作为区块是冲突的。链和冲突区块的语言足以表达任何这样的逻辑，因此我们在本文中假设什么区块可以是其他区块的子区块的语法已经被设计为嵌入逻辑一致性的语义，这允许我们忽略逻辑，只从链和冲突区块的角度思考。

### 2.6 时间、时段与同步性

在我们的模型中，我们以*时隙*为单位测量时间，时隙定义为某个固定的秒数（在 [11] 中暂定为 12 秒）。然后我们将一个*时段*定义为一定数量 $C$ 的时隙（在 [11] 中暂定为 64 个时隙）。时隙 $i$ 的*时段* $j$ 是 $\text{ep}(i)=j=\lfloor\frac{i}{C}\rfloor$。换句话说，属于时段 $j$ 的区块具有时隙编号 $jC+k$，其中 $k$ 遍历 $\{0,1,\ldots,C-1\}$。创世区块 $B_{\text{genesis}}$ 的时隙编号为 $0$，是时段 $0$ 的第一个区块。

时段的主要目的是将时间分成片段，其间的边界可以视为“检查点”。这将允许使用来自 Casper FFG 的概念，正如我们将在第 3.1 节看到的那样。

我们不应该假设网络保证验证者在任何给定时间看到相同的消息，甚至不同的验证者对时间有相同的看法。共识协议的研究通过设置不同的*同步条件*来解决这个问题，例如：

*   一个*同步*系统对节点间发送消息所需的时间有明确的上限；
*   一个*异步*系统没有保证；回想一下 PBFT [8] 在异步下工作。
*   一个*部分同步*系统根据上下文可能意味着两件事之一：（i）延迟的明确上限存在，但并非先验已知；（ii）在某个未知时间 $T$ 之后，已知存在明确的延迟上限。工作 [10] 在不同的故障和同步模型中建立了容错界限，侧重于部分同步性。

对我们来说，在研究安全性和合理活跃性时，我们不做同步性假设。在研究概率活跃性（即尝试量化“现实”条件下的活跃性）时，我们将使用上述的部分同步性概念 (ii)。如果所有时间戳在或早于时间 $(T-t)$ 的消息在时间 $T$ 及之后都出现在所有验证者的视图中，我们说网络在时间 $T$（其中 $T$ 和 $t$ 都以时隙为单位）是*$t$-同步的*；例如，如果每个时隙是 12 秒，那么 $(1/2)$-同步意味着所有消息最多延迟 6 秒被接收。

**备注。** 有可能接收到例如“来自未来”的消息。假设 Alexis 在 00:01:30 PT 发送一条时间戳为此时的消息，Bob 在 1 秒后收到它，但 Bob 的时钟比 Alexis 的慢 3 秒。Bob 在自己的时钟上看到这条 00:01:30 PT 的消息时间戳为 00:01:28 PT，因为他总共慢了 2 秒。为了使分析更容易，我们可以假设所有（诚实）验证者总是延迟接收消息（即，不将其添加到他们的视图中），直到他们自己的时间戳达到消息的时间戳。这允许我们假设没有消息（同样，由诚实验证者）在比它们应该的时间更早的时隙被读取。

## 3 主要组成部分

### 3.1 Casper FFG

Buterin 和 Griffith 在 [7] 中介绍了友好最终性小工具 Casper FFG。该工具定义了*合理化*和*最终确定*的概念，灵感来源于实用拜占庭容错（PBFT）文献。Casper 被设计用于具有类树结构的广泛区块链协议类别。

*   每个区块都有一个*高度*，由其距离创世区块的长度定义（创世区块高度为 $0$）。等价地，$B$ 的高度是 chain$(B)-1$ 的长度。
*   我们定义*检查点*区块为高度是常数 $H$ 的倍数的区块（在 [7] 中，$H=100$）。我们为检查点区块 $B$ 定义*检查点高度* $h(B)$ 为 $B$ 的高度除以 $H$，这总是一个整数。因此，我们可以将

视图中的检查点子集视为一个子树，仅包含高度为 $H$ 的倍数的区块。

*   *证明*是包含“检查点边” $A\to B$ 的签名消息，其中 $A$ 和 $B$ 是检查点区块。我们可以将每个这样的证明视为从区块 $A$ 到 $B$ 的一个“投票”。$A$ 和 $B$ 的选择取决于底层区块链，不是 Casper 的一部分。每个证明都有一个*权重*，即编写该证明的验证者的权益。理想情况下，$h(B)=h(A)+1$，但这不是必须的。例如，如果 $H=100$，诚实的验证者可能以某种方式错过了区块 $200$，那么他们的底层区块链可能希望他们发送一个从检查点区块 $100$ 到检查点区块 $300$ 的证明。

**备注。** 注意我们以*时隙*为单位设置时间，时隙被分组为*时段*。这类似于（但并不完全相同于）区块高度和检查点区块。我们将在第 4.1 节进一步讨论这一点。

Casper FFG 还引入了*合理化*和*最终确定*的概念，它们类似于 PBFT 文献中基于阶段的概念，如*准备*和*提交*，例如参见 [8]：

*   在每个视图 $G$ 中，有一组*合理化*的检查点区块 $J(G)$ 和一个*最终确定*的检查点区块子集 $F(G)\subset J(G)$。创世区块始终既是合理化的又是最终确定的。
*   在视图 $G$ 中，一个检查点区块 $B$ 是*合理化的*（由一个合理化的检查点区块 $A$），如果 $A$ 是合理化的，并且有总权重至少为总验证者权益 $2/3$ 的证明为 $A\to B$ 投票。等价地，我们说存在一个*绝对多数链接* $A\stackrel{{J}}{{\to}}B$。这是一个依赖于视图的条件，因为所讨论的视图可能看到也可能没有看到所有相关的证明以达到 $2/3$ 的阈值（甚至可能看到区块 $B$ 本身），这就是为什么合理化区块的集合以 $G$ 为参数的原因。
*   在视图 $G$ 中，如果 $A\in J(G)$（等价地，$A$ 是合理化的），并且 $A\stackrel{{J}}{{\to}}B$ 是一个绝对多数链接，且 $h(B)=h(A)+1$，那么我们就说 $A\in F(G)$（等价地，$A$ 是*最终确定的*）。

最后，Casper 引入了*罚没条件*，这些是关于诚实验证者的假设。当验证者 $V$ 违反这些条件时，不同的验证者 $W$ 可以通过提供 $V$ 违反条件的证明来*罚没* $V$（销毁 $V$ 的权益，并可能获得某种“罚没奖励”）。

**定义 3.1** 以下*罚没条件*，当违反时，会导致违反它们的验证者的权益被罚没：

*   (S1) 没有验证者制作两个不同的证明 $\alpha_{1}$ 和 $\alpha_{2}$，分别对应于检查点边 $s_{1}\to t_{1}$ 和 $s_{2}\to t_{2}$，且 $h(t_{1})=h(t_{2})$。
*   (S2) 没有验证者制作两个不同的证明 $\alpha_{1}$ 和 $\alpha_{2}$，分别对应于检查点边 $s_{1}\to t_{1}$ 和 $s_{2}\to t_{2}$，使得
    $$h(s_{1})<h(s_{2})<h(t_{2})<h(t_{1}).$$

由于 Casper 是一个最终性小工具而非完整协议，它假设底层协议有自己的分叉选择规则，并且在每个时段，所有验证者在某个时刻运行分叉选择规则以进行一次（且仅一次）证明。假设遵循底层协议的诚实验证者永远不会被罚没。例如，如果协议要求每个时段恰好进行一次证明，那么诚实验证者永远不会违反 (S1)。

Casper 中的主要定理是（稍微转述）：

**定理 3.2**（可问责安全性）。不同分支上的两个检查点不能都被最终确定，除非一组拥有超过某总权益的验证者明确违反了协议（因此可以被追究责任）。

**定理 3.3**（合理活跃性）。只要底层区块链可以创建新区块，总是有可能使新的检查点被最终确定。

**备注。** Palmskog 等人 [17] 在 Coq 证明助手中为 Casper FFG 的可问责安全性和合理活跃性提供了机械化证明助理。作者修改了 Coq 中的区块链模型 Toychain，以用于具有以太坊信标链规范的 Casper FFG，以了解 Casper FFG 的证明在实践中如何工作。

### 3.2 LMD GHOST 分叉选择规则

最贪婪最重观察子树规则（GHOST）是由 Sompolinsky 和 Zohar [20] 引入的分叉选择规则。直观地说，GHOST 是一种贪心算法，在具有“最多活动”的子分支上增长区块链。Zamfir [22] 在寻找“构造正确”的共识协议时，引入了 GHOST 的自然改编，恰好非常适合我们的设置4。我们称这种变体为*最新消息驱动最贪婪最重观察子树（LMD GHOST）*，在有了*权重*的概念后我们可以定义它：

Footnote 4: 领域的这一部分可能会造成幽灵般的混淆：[22] 的名称是“Casper the Friendly GHOST”，它介绍了 Casper CBC（另见 [5]），这是一个与 Casper FFG 完全独立的协议。我们的论文在某种意义上重新结合了这两个想法，但 [22] 中的“Casper”与 Casper FFG 非常不同。

**定义 3.4** 给定一个视图 $G$，设 $M$ 为最新证明的集合，每个验证者一个。*权重* $w(G,B,M)$ 定义为那些在 $M$ 中最后一个证明是针对 $B$ 或 $B$ 的后代的验证者 $i$ 的权益之和。

图 3：LMD-GHOST 分叉选择规则的一个示例。每个区块 $B$ 中的数字是权重（按权益），在我们的示例中所有证明（圆圈）的权重都是 $1$。使用此视图的验证者将得出结论：蓝色链是规范链，并输出左边最新的蓝色区块（权重为 $3$）作为链头。

## 4 主协议：Gasper

我们现在定义我们的主协议 Gasper，它结合了 GHOST 和 Casper FFG 的思想。主要概念是：

*   *（时段边界）配对*：给定一条链，挑选出某些区块，理想情况下每个时段一个，以扮演 Casper *检查点*的角色。然而，同一个区块可能在同一链上多次作为检查点出现（这是 Casper 中没有的细微差别；我们将在第 4.1 节详述），因此我们使用有序对 $(B,j)$，其中 $B$ 是一个区块，$j$ 是一个时段，以消除歧义。这些将被称为*时段边界配对*，或简称*配对*。
*   *委员会*：验证者在每个时段被划分为*委员会*，每个时隙一个委员会。在每个时隙，指定委员会中的一名验证者提议一个区块。然后，该委员会的所有成员将使用分叉选择规则 HLMD GHOST（LMD GHOST 的一个轻微变体）证明他们认为的链头（希望就是刚刚提议的区块）。
*   *合理化与最终确定*：这些概念与 Casper FFG 几乎完全相同，只是我们合理化和最终确定配对，而不是合理化和最终确定检查点区块，即，给定视图 $G$，$J(G)$ 和 $F(G)$ 是配对的集合。

### 4.1 时段边界区块与配对

回想任何特定的区块 $B$ 唯一确定一条链 $\text{chain}(B)$。对于一个区块 $B$ 和一个时段 $j$，定义 $\text{EBB}(B,j)$，即 $B$ 的第 $j$ 个*时段边界区块*，为 $\text{chain}(B)$ 中时隙小于或等于 $jC$ 的最高区块。让最新的这样的区块为 $\text{LEBB}(B)$，或*最后时段边界区块*（$B$ 的）。我们做一些观察：

*   对于每个区块 $B$，$\text{EBB}(B,0)=B_{\text{geneis}}$。
*   更一般地，如果 $\text{slot}(B)=jC$ 对于某个时段 $j$，$B$ 将包含它的每条链中都是时段边界区块。
*   然而，没有这样的假设，一个区块可能在一些链中是时段边界区块，但在其他链中不是。

为了消除此类情况的歧义，我们通过引入*时段边界配对*（或简称*配对*）$(B,j)$ 来增加精确性，其中 $B$ 是区块，$j$ 是时段。我们的合理化和最终确定的主要概念将作用于这些配对。给定一个配对 $P=(B,j)$，我们说 $P$ 具有*证明时段* $j$，使用符号 $\text{aep}(P)=j$，这**不一定**与 $\text{ep}(B)$ 相同。

**示例 4.1** 假设区块（用时隙标记）形成一条链 $63\gets 64\gets 65$，并且存在一个分叉 $63\gets 66$。那么 $\text{EBB}(65,1)=64$，因为 $64$ 在 $\text{chain}(65)$ 中。当我们试图找到 $\text{EBB}(66,1)$ 时，我们寻找区块 $64$，因为我们处于时段 $1$，并意识到它不在 $\text{chain}(66)$ 中，所以我们不得不向后看，并“拉出”前一时段的区块 $63$ 来充当

图 4：时段边界区块和配对的示例。区块用其时隙编号标记。“$63$”不是实际区块，但说明了 $66$ 需要在时隙 $64$ 有一个时段边界区块但未能找到的视角。

在此链中的时段边界区块。这由图 4 中的虚线组件可视化。注意即使 aep$(63,1)$ 和 ep$(63)=0$，ep() 是一个仅取决于区块时隙的局部属性，而时段边界概念如 aep() 则取决于链的上下文。

**备注。** 我们进一步阐述为什么使用配对而不是检查点区块。Casper FFG 是一个“最终性小工具”，意味着它被设计为在具有概率活跃性的区块链上放置一层最终性，这提供了稳定的新检查点区块供应。概率活跃性假设了良好的同步条件。对于设计的安全性部分，我们希望做出更少的假设，并考虑到最坏情况的场景，即我们可能进入一个有一段时间没有看到新区块的状态。

例如，区块 $B$ 可能是时段 $1$ 的链头，但当前处于时段 $3$，且没有在 $B$ 之上构建新区块。在原始的 Casper FFG 中，我们期望概率活跃性，因此我们每个时段都会有不同的检查点。然而，当我们没有同步性假设时，在分析中，我们需要区分“时段 $2$ 的检查点”和“时段 $3$ 的检查点”的概念，即使两者的最佳候选是 $B$，而 $B$ 本身仍然只处于时段 $1$！这自然引出了概念 $(B,2)$ 和 $(B,3)$，它们代表了如果“应该在那里”的检查点区块缺失，对后一时段检查点的最佳近似。

此外，Casper FFG 对底层区块链的时间不做假设——只有区块高度重要，没有*时隙*或*时段*的概念。在权益证明区块链中，由于挖矿新区块的泊松过程在一定程度上充当了系统时钟，区块到达时间相当不规则，因此使用区块高度是一个自然的选择。而作为权益证明协议，Gasper 可以将区块以受控的规律时间间隔到达作为协议的一部分（而不是依赖于随机过程），因此协议中明确需要时间的概念。为了捕捉这种时间概念，我们区块链中的每个对象自然需要同时知道数据（体现在区块中）和时间（体现在时段计数中），这也自然而然地引出了配对的概念。

### 4.2 委员会

委员会的目的是在验证者之间分配职责。首先，假设验证者可以访问一系列长度为 $N$ 的随机排列 $\rho_{0},\rho_{1},\ldots$，作为函数 $\{1,2,\ldots,N\}\rightarrow\{1,2,\ldots,N\}$。在本文的范围内，我们假设从随机预言机5获得这些随机排列。

Footnote 5: 在区块链上实现不可利用的随机性本身是一个有趣的问题，刺激了诸如可验证延迟函数等研究；然而，在本文中，我们将这种随机性视为理所当然。

回想时间被划分为时段，每个时段有 $C$ 个时隙。每个排列 $\rho_{j}$ 将仅在时段 $j$ 期间使用。它的作用是伪随机地将验证者选择到 $C$ 个*委员会*中，每个委员会负责时段中的一个时隙。具体来说：

*   在时段 $j$ 期间，我们希望将验证者集合 $V$ 分割成 $C$ 个等大小的委员会 $S_{0},S_{1},\ldots,S_{C-1}$（为了记号简便，我们假设 $C|N$；处理“大致相等”大小的委员会不会改变我们方法的本质）。
*   因此，对于每个 $k\in\{0,1,\ldots,C-1\}$，我们定义 $S_{k}$ 为形式为 ${\cal V}_{\rho_{j}(s)}$ 的 $N/C$ 个验证者的集合，其中 $s\equiv k\pmod{C}$。注意，对于一个时段 $j$，集合 $S_{0},S_{1},\ldots,S_{C-1}$ 在整个验证者集合 $\{V_{1},\ldots,V_{N}\}$ 上跨时段 $j$ 的所有时隙进行了划分，正如所愿。

总之，在每个时段 $j$，$\rho_{j}$ 允许我们将验证者洗牌到 $C$ 个委员会中。我们的工作除了这个直观理解外，不假设更多。

### 4.3 区块与证明

现在，在每个时隙中，协议为其各自时隙分配的委员会规定了 $2$ 种“委员会工作”：委员会中的一个人需要*提议*一个新区块，委员会中的每个人都需要*证明*他们所认为的链头。提议区块和进行证明都意味着立即将相应的消息（分别为区块和证明）添加到验证者自己的视图中，然后将消息广播到网络。回想提议（非创世）区块和发布证明的消息具有数字签名。

提议和证明都要求委员会成员在验证者自己的视图上运行相同的分叉选择规则 HLMD()，这是 LMD GHOST 分叉选择规则的一个变体。HLMD() 的定义需要一些我们尚未引入的概念，因此我们将其定义推迟到第 4.6 节。目前，我们只需要知道，像 LMD GHOST 一样，HLMD() 接受一个视图 $G$ 并返回一个叶区块 $B$ 作为链头，使得 $\text{chain}(B)$ 成为 $G$ 的规范链。

我们现在给出在时隙 $i=jC+k$ 期间协议的责任，其中 $k\in\{0,1,\ldots,C-1\}$。所有对时间的提及都是从验证者本地时钟的角度计算的，我们假设本地时钟在某个 $\delta$ 内同步。

**定义 4.2** 在时隙 $i=jC+k$ 开始时，指定验证者 $V=V_{\rho_{j}(k)}$，即时段 $j$ 的委员会 $S_{k}$ 的第一个成员，为该时隙的*提议者*。提议者计算其视图中的规范链头，即 HLMD(view$(V,i))=B^{\prime}$，然后*提议一个区块 B*，这是一个包含以下内容的消息：

1.  slot$(B)=i$，时隙编号。
2.  $P(B)=B^{\prime}$，指向父区块的指针；换句话说，我们总是在链头的顶部构建区块。
3.  newattests$(B)$，指向 $V$ 已接受但尚未包含在任何祖先区块 $B^{\prime}$ 的 newattests$(B^{\prime})$ 中的所有*证明*（接下来定义）的指针集合。
4.  一些实现特定的数据（例如，如果我们在跟踪代币，可能是“Yunice 支付了 4.2 ETH 给 Brad”），其语义对我们无关紧要。

对于依赖项，$B$ 依赖于 $P(B)$ 和 newattests$(B)$ 中的所有证明（因此，例如，如果我们在网络上看到一个区块但没有看到其父区块，我们会忽略该区块，直到我们看到其父区块）。

在典型的（诚实的）行为中，我们可以假设每个有相关联区块的时隙编号在 view(NW) 中最多只有一个这样的区块。默认情况下，$B_{\text{sencsis}}$ 是时隙为 $0$ 的唯一区块。理论上，不诚实的验证者可以创建一个具有与时隙编号与现有区块重复的区块，但我们可以假设数字签名和区块提议选择的伪随机生成器设置得当，以便可以明确抓住此类行为。例如，每次一个数字签名的区块进入验证者的视图时，验证者可以立即检查该区块提议者是否是允许为该时隙提议区块的唯一人选。验证者也可以通过简单地指向两个区块来证明同一个人在同一时隙提议了两个区块。

**定义 4.3** 在时间 $(i+1/2)$，即时隙 $i=jC+k$ 的中间时刻，委员会 $S_{k}$ 中的每个验证者 $V$ 计算 $B^{\prime}=\text{HLMD}\left(\text{view}(V,i+1/2)\right)$，并发布一个*证明* $\alpha$，这是一个包含以下内容的消息：

1.  slot$(\alpha)=jC+k$，验证者进行证明的时隙。我们也将使用 ep$(\alpha)$ 作为 ep (slot$(\alpha)$) 的简写。
2.  block$(\alpha)=B^{\prime}$。我们说 $\alpha$ *证明* block$(\alpha)$。我们将有 slot (block$(\alpha))\leq \text{slot}(\alpha)$，并且“通常”通过快速证明刚刚在该时隙提议的区块而得到等号。
3.  一条*检查点边* $\text{LJ}(\alpha)\xrightarrow{\vee}\text{LE}(\alpha)$。这里，$\text{LJ}(\alpha)$ 和 $\text{LE}(\alpha)$ 是 view$(V,i+1/2)$ 中的时段边界配对。我们将在第 4.4 节正确定义它们。

对于依赖项，$\alpha$ 依赖于 block$(\alpha)$。因此，在我们接受其证明的区块进入我们的视图之前，我们忽略一个证明（这是理论与实现之间的较大差异之一；我们将在第 8 节进一步讨论）。

直观地说，$\alpha$ 同时在做两件事：它既是对其区块的“GHOST 投票”，也是两个时段边界配对之间过渡的“Casper FFG 投票”（类似于 Casper 的检查点区块）。

### 4.4 合理化

**定义 4.4** 给定一个区块 $B$，我们定义6 view$(B)$，即*$B$ 的视图*，为包含 $B$ 及其在依赖图中的所有祖先的视图。我们定义 $\mathsf{ffgview}(B)$，即*$B$ 的 FFG 视图*，为 $\mathsf{view}(\mathsf{LEBB}(B))$。

Footnote 6: 到此时，我们已经专横地过度使用了 view() 这个符号，但当我们知道其参数的类型时，应该没有歧义。

定义 $\mathsf{view}(B)$ 是“与观看者无关的”，任何接受了 $B$ 的视图都可以计算出一个相同的 view$(B)$，因此我们不需要向参数提供验证者（或 NW）。直观地说，$\mathsf{view}(B)$ 将视图“聚焦”到 chain$(B)$，而 $\mathsf{ffgview}(B)$ 查看 view$(B)$ 在最后一个检查点的“冻结”快照。Casper FFG 仅作用于时段边界配对，因此区块 $B$ 的 FFG 视图提取了 chain$(B)$ 中与 Casper FFG 相关的确切信息。

我们现在定义合理化的主要概念。首先，回想 Gasper 的证明 $\alpha$ 包含一条*检查点边* $\mathsf{LJ}(\alpha)\xrightarrow{\vee}\mathsf{LE}(\alpha)$，作为两个时段边界配对之间的“FFG 投票”。在几个新定义之后，我们终于可以显式地定义这些概念。

**定义 4.5** 如果具有检查点边 $(A,j^{\prime})\xrightarrow{\vee}(B,j)$ 的证明的总权重大于总验证者权益的 $\frac{2}{3}$，我们说存在从配对 $(A,j^{\prime})$ 到配对 $(B,j)$ 的*绝对多数链接*。在这种情况下，我们写作 $(A,j^{\prime})\xrightarrow{j}(B,j)$。

**定义 4.6** 给定一个视图 $G$，我们如下定义*合理化*配对的集合 $J(G)$：

*   $(B_{\text{geneis}},0)\in J(G)$；
*   如果 $(A,j^{\prime})\in J(G)$ 且 $(A,j^{\prime})\xrightarrow{j}(B,j)$，那么 $(B,j)\in J(G)$。

如果 $(B,j)\in J(G)$，我们说 $B$ *在时段 $j$ 在 $G$ 中被合理化*。

**定义 4.7** 给定一个证明 $\alpha$，令 $B=\mathsf{LEBB}(\mathsf{block}(\alpha))$。我们定义：

1.  $\mathsf{LJ}(\alpha)$，*$\alpha$ 的最后合理化配对*：$\mathsf{ffgview}(\mathsf{block}(\alpha))=\mathsf{view}(B)$ 中具有最高证明时段（或最后）的合理化配对。
2.  $\mathsf{LE}(\alpha)$，*$\alpha$ 的最后时段边界配对*：$(B,\mathsf{ep}(\mathsf{slot}(\alpha)))$。

虽然我们为任何视图 $G$ 定义了 $J(G)$，但我们通常只对 $G=\mathsf{ffgview}(B)$ 的 $J(G)$ 感兴趣。我们可以将每条链视为拥有自己的合理化区块/配对的“状态”，该状态仅在时段边界处更新。

**示例 4.8** 一个验证者在其视图 $G$ 上运行 $\mathsf{HLMD}(G)$ 以获得其链头，即区块 $193$。然后她应该用一个证明 $\alpha$ 来证明 $193$。

在图 5 描绘的 chain$(193)$ 上，$\mathsf{LE}(\alpha)=(180,3)$，即使 $\mathsf{ep}(180)=2$，因为我们的证明具有时段 $3$，并且我们正在寻找 $3*64=192$ 但没有看到它（可以想象，如图中所示，我们“拉出”区块 $180$ 以表明它是 $\mathsf{EBB}(193,3)$）。在 $\mathsf{ffgview}(193)=\mathsf{view}(180)$ 中，最后合理化（按时段编号，而不是时隙）的配对是 $(64,2)$，所以 $\mathsf{LJ}(\alpha)=(64,2)$。

图 5：验证者在时段 $3$ 撰写证明时的视图 $G$。在时段 $1$，延迟问题使她看不到任何区块，因此区块 $64$ 既是 $\mathsf{EBB}(193,1)$ 又是 $\mathsf{EBB}(193,2)$。她最终撰写了一个 $\alpha$，其中包含对 $\mathsf{block}(\alpha)=193$ 的“GHOST 投票”和对 $\alpha$ 的检查点边（单弧边） $(64,2)\xrightarrow{\vee}(180,3)$ 的“FFG 投票”。区块用时隙编号表示，因此区块 $0$ 就是 $B_{\text{geneis}}$。红色区块是（在 $G$ 中）合理化的。双线箭头对应绝对多数链接。

注意，这依赖于 view$(180)$ 包含指向 $(64,2)$ 的至少价值 $(2N/3)$-权益的证明。有可能出现这样的情况：到 $180$ 时这种情况没有发生，但该链到 $193$ 时看到了价值 $(2N/3)$ 的证明。在这种情况下，$(64,2)$ 在 $J(G)$ 中，但 $(64,2)$ 不在 $J(\textsf{ffgview}(193))$ 中，因此产生的检查点边将是，例如，$(64,1)\xrightarrow{\vee}(180,3)$，假设 $(64,1)$ 的证明在 view$(180)$ 中。检查点边甚至可能是 $(0,0)\xrightarrow{\vee}(180,3)$，如果 $180$ 没有看到那些证明；注意，如果 $(64,1)$ 的证明仅包含在从 chain$(193)$ 分叉出去的区块（如区块 $130$）中，这是非常可能的，因为分叉可能是网络问题的迹象，导致这些证明暂时对 chain$(193)$ 上的验证者不可用。

这里的一切都类似于 Casper FFG。block$(\alpha)$ 的链内部有一条由该链的时段边界区块创建的子链，从 $B_{\text{genesis}}$ 开始到 $B=\textsf{LEBB}(\alpha)$ 结束。我们希望专注于这个区块子链（用配对表示以允许边界情况），并用许多证明合理化时段边界配对；这个子链正是 $\mathsf{ffgview}(\mathsf{block}(\alpha))$ 所捕获的内容。$\alpha$ 是对从某个最后合理化配对 $(B^{\prime},j^{\prime})$ 过渡到新配对 $(B,j)$ 的投票，可视化为检查点边 $(A,j^{\prime})\xrightarrow{\vee}(B,j)$。如果发生价值 $(2N/3)$ 权益的此类投票，我们创建一个绝对多数链接 $(A,j^{\prime})\xrightarrow{}\allowbreak(B,j)$ 并合理化 $(B,j)$。

### 4.5 最终确定

有了我们的*合理化*概念和一个新的分叉选择规则，我们现在可以定义*最终确定*的概念。最终确定是合理化的一个更强概念，其含义是**任何**视图将区块 $B$ 视为对某个 $j$ 最终确定的时刻，**没有**视图会最终确定一个与 $B$ 冲突的区块，除非区块链是 $(1/3)$-可罚没的。

**定义 4.9** 对于视图 $G$，如果 $(B_{0},j)=(B_{\text{genesis}},0)$，或者如果存在一个整数 $k\geq 1$ 和区块 $B_{1},\ldots,B_{k}\in \text{view}(G)$ 使得以下条件成立，我们说 $(B_{0},j)$ 在 $G$ 中是*最终确定的*（具体地，$k$*-最终确定的*）：

*   $(B_{0},j),(B_{1},j+1),\ldots,(B_{k},j+k)$ 是 chain$(B_{k})$ 中的相邻时段边界配对；
*   $(B_{0},j),(B_{1},j+1),\ldots,(B_{k-1},j+k-1)$ 都在 $J(G)$ 中；
*   $(B_{0},j)\xrightarrow{}\allowbreak(B_{k},j+k)$。

我们定义 $F(G)$ 为视图 $G$ 中最终确定的配对的集合；我们也说，如果 $(B,j)\in F(G)$ 对于某个时段 $j$，区块 $B$ 是*最终确定的*。

我们期望在绝大多数时间里得到 $1$-最终确定的区块。具体来说，这只是意味着我们有区块 $B_{0}$ 和 $B_{1}$，使得 $(B_{0},j)$ 在 $G$ 中是合理化的且 $(B_{0},j)\xrightarrow{}\allowbreak(B_{1},j+1)$，或者“一个合理化的时段边界区块合理化下一个相邻的时段边界区块”。这本质上是 [7] 中*最终确定*的原始定义。在 $(1/2)$-同步性且没有干扰接受消息的实现细节的情况下，我们应该只得到 $1$-最终确定。我们包含 $k>1$ 的情况是为了考虑网络延迟和证明包含延迟（见第 8.3 节）相关的情况。

**备注。** 在图 6 中，我们看到一些最终确定的例子。在左边，我们有 $1$-最终确定，这是我们在绝大多数时间里期望发生的。在中间，我们有一个 $2$-最终确定的例子，以考虑证明延迟。$k=3$ 的例子主要是为了说明；需要一些刻意编排才能创建。在实践中，[11] 中规划的最终确定实现甚至不包括 $k\geq 3$ 的最终确定。参见第 8.5 节。

图 6：分别针对 $k=1,2,3$ 的定义 4.9 的说明性示例。双箭头是绝对多数链接。蓝色区块是在每种情况下被最终确定的区块。

如果我们定义一组区块 $F$ 为最终确定的并证明它们的安全性，那么如果我们更改*最终确定*的定义为 $F$ 的任何子集，安全性自动保持成立，因为安全性是通过缺乏不可比较的最终确定配区块对来定义的。因此，如果我们可以证明安全性，定义一个非常通用的区块类为最终确定的并没有坏处。这就是为什么我们在定义中包含所有 $k$；更通用的定义更容易分析。

### 4.6 混合 LMD GHOST

我们现在有足够的符号来定义 HLMD。由于最终设计乍一看相当复杂，我们首先呈现算法 4.1，一个“原型”版本；简而言之，它从视图中的最后一个合理化区块开始，然后运行 LMD GHOST。$(B_{J},j)$ 应该是唯一的，这并不明显，但当区块链不是 $(1/3)$-可罚没时，可以作为引理 4.11 的结果被证明是良定义的。对于实现来说，添加一个决胜机制（比如通过区块头哈希）是无成本的。

**算法 4.1 原型混合 LMD GHOST 分叉选择规则**

1.  **procedure** HLMD($G$)
2.  $\quad$ $(B_{J},j)\leftarrow$ $G$ 中具有最高证明时段 $j$ 的合理化配对
3.  $\quad$ $B\gets B_{J}$
4.  $\quad$ $M\leftarrow$ 最新证明（每个验证者一个）
5.  $\quad$ **while** $B$ 在 $G$ 中不是叶区块 **do**
6.  $\quad$ $\quad$ $B\leftarrow \operatorname*{arg\,max}_{B^{\prime}\text{ 是 }B\text{ 的子区块}} w(G,B^{\prime},M)$ （平局通过区块头哈希打破）
7.  $\quad$ **end while**
8.  $\quad$ **return** B
9.  **end procedure**

然而，使用这个原型会遇到一些微妙的问题。因为证明的“FFG 部分”是时段边界配对之间的投票，并且 $\mathsf{LJ}(B)$ 仅依赖于 $\mathsf{ffgview}(B)$，我们可以将“链中的最后合理化配对”视为在每个时段的开始“冻结”，这与本能地定义为整个视图中最后合理化区块的“非冻结”$(B_{J},j)$ 不能很好地混合，因为后一个定义可能在一个时段内发生变化（鼓励读者思考其中的问题，作为练习）。因此，我们需要一个在时段中间不变化的 $(B_{J},j)$ 版本。

另一个问题发生在算法分叉时：分叉的区块可能有截然不同的最后合理化配对，即使它们彼此相邻。由于这种不匹配，如果验证者先前证明了一个更高的最后合理化时段，然后分叉到一个其最后合理化时段更早的链中，遵循算法 4.1 的诚实验证者可能会罚没自己（参见定义 4.10，S2）。

为了解决这些问题，首先，我们将最新合理化配对 $(B_{J},j)$ 的状态“冻结”到时段的开始；形式上，这意味着在定义 $(B_{J},j)$ 时，我们考虑叶区块 $B_{l}$ 的 $\mathsf{ffgview}(B_{l})$ 的视图，而不是整个视图。然后，我们对分支进行过滤，使我们不会进入那些叶节点 $B_{l}$ 的 $\mathsf{LJ}(B_{l})$ 尚未“赶上” $(B_{J},j)$ 的分支；形式上，我们从 $G$ 创建一个辅助视图 $G^{\prime}$，消除有问题的分支。这些修复给出了算法 4.2，即最终设计。

**算法 4.2 混合 LMD GHOST 分叉选择规则**

1.  **procedure** HLMD($G$)
2.  $\quad$ $L\leftarrow$ $G$ 中叶区块 $B_{l}$ 的集合
3.  $\quad$ $(B_{J},j)\leftarrow$ 在 $B_{l}\in L$ 上，$J(\mathsf{ffgview}(B_{l}))$ 中具有最高证明时段 $j$ 的合理化配对
4.  $\quad$ $L^{\prime}\leftarrow$ $G$ 中叶区块 $B_{l}$ 的集合，使得 $(B_{j},j)\in J(\mathsf{ffgview}(B_{l}))$
5.  $\quad$ $G^{\prime}\leftarrow$ 所有 $\mathrm{chain}(B_{l})$ 在 $B_{l}\in L^{\prime}$ 上的并集
6.  $\quad$ $B\gets B_{J}$
7.  $\quad$ $M\leftarrow$ 最新证明（每个验证者一个）
8.  $\quad$ **while** $B$ 在 $G^{\prime}$ 中不是叶区块 **do**
9.  $\quad$ $\quad$ $B\leftarrow \operatorname*{arg\,max}_{B^{\prime}\text{ 是 }B\text{ 的子区块}} w(G^{\prime},B^{\prime},M)$ （平局通过区块头哈希打破）
10. $\quad$ **end while**
11. $\quad$ **return** B
12. **end procedure**

理解算法 4.2 的一种双重（可能更简单）方式是从协议基于状态的实现的角度来看。我们可以将叶区块 $B_{l}$ 的每条链视为存储其自己的最后合理化配对的状态。在一个时段内，对链中区块的新证明更新了与 GHOST 相关的最新证明列表 $M$，但**不会**更新链的与 FFG 相关的合理化和最终确定信息，直到下一个时段边界区块。这样，协议的“FFG 部分”始终使用“冻结到下一个时段”的信息工作，而协议的“GHOST 部分”则随着证明不断更新。这种仔细的分离使我们能够避免混合两种协议所带来的病态问题。

### 4.7 罚没条件

在本小节中，我们添加*罚没*条件，类似于定义 3.1 中的 Casper 条件。我们证明几个期望的性质，之后我们就可以使用这些条件在第 5 节中证明 Gasper 的安全性。

**定义 4.10** 我们定义以下*罚没条件*：

*   (S1) 没有验证者制作两个不同的证明 $\alpha_{1},\alpha_{2}$，且 $\mathsf{ep}(\alpha_{1})=\mathsf{ep}(\alpha_{2})$。注意这个条件等价于 $\mathsf{aep}\left(\mathsf{LE}\left(\alpha_{1}\right)\right)=\mathsf{aep}\left(\mathsf{LE}\left(\alpha_{2}\right)\right)$。
*   (S2) 没有验证者制作两个不同的证明 $\alpha_{1},\alpha_{2}$，且
    $$\mathsf{aep}\left(\mathsf{LJ}\left(\alpha_{1}\right)\right)<\mathsf{aep}\left(\mathsf{LJ}\left(\alpha_{2}\right)\right)<\mathsf{aep}\left(\mathsf{LE}\left(\alpha_{2}\right)\right)<\mathsf{aep}\left(\mathsf{LE}\left(\alpha_{1}\right)\right).$$

我们现在证明协议的一个非常有用的性质：除非我们处于不太可能的情况，即我们有足够的证据来罚没至少总权益 $1/3$ 的验证者，否则在视图 $G$ 中，我们可以假设 $J(G)$ 中的所有元素具有唯一的证明时段（换句话说，该视图在每个时段最多看到一个合理化配对）。

**引理 4.11** 在视图 $G$ 中，对于每个时段 $j$，$J(G)$ 中最多有 $1$ 个配对 $(B,j)$，否则区块链是 $(1/3)$-可罚没的。特别是，后一种情况意味着必须存在 $\mathcal{V}$ 的 $2$ 个子集 $\mathcal{V}_{1},\mathcal{V}_{2}$，每个的总权重至少为 $2N/3$，使得它们的交集违反罚没条件 (S1)。

*证明：* 假设我们在 $J(G)$ 中有 $2$ 个不同的配对 $(B,j)$ 和 $(B^{\prime},j)$。这意味着在时段 $j$，超过总权益 $2N/3$ 的证明以检查点边指向 $(B,j)$，并且超过 $2N/3$ 权益的证明以检查点边指向 $(B^{\prime},j)$。这些就是我们期望的 $\mathcal{V}_{1}$ 和 $\mathcal{V}_{2}$。

**备注。** 引理 4.11 的重要性在于，在合理的条件下（我们不是 $(1/3)$-可罚没的），算法 4.2 中 $(B_{j},j)$ 的选择是唯一的，因此是良定义的。更一般地，我们可以假设任何视图在所有链上每个时段 $j$ 最多只看到一个合理化配对 $(B,j)$。

**命题 4.12** 遵循协议的诚实验证者永远不会意外地违反罚没条件。

*证明：* 首先，注意诚实验证者不能违反 (S1)，因为每个验证者在每个时段被分配到恰好一个委员会，因此被要求每个时段恰好证明一次。因此，只需考虑 (S2)。

假设一个诚实验证者 $V$ 即将在时段 $u$ 撰写一个违反 (S2) 的证明。这意味着存在时段 $r<s<t<u$，其中在时段 $t$，$V$ 撰写了一个证明 $\alpha_{t}$，其检查点边为 $(B_{2},s)\xrightarrow{V}(B_{3},t)$，而协议现在告诉 $V$ 撰写一个证明 $\alpha_{u}$，其检查点边为 $(B_{1},r)\xrightarrow{V}(B_{4},u)$。这意味着在 $V$ 的当前视图上运行 HLMD GHOST 最终到达某个叶区块 $B$，它必须是 $B_{4}$ 的后代，使得 $\mathsf{LE}(B)=(B_{4},u)$。

因为 $V$ 在时段 $t<u$ 撰写了 $\alpha_{t}$，我们知道 $(B_{2},s)$ 在当时的时段 $t$ 的某个叶区块的 ffgview() 中是一个合理化配对。由于合理化区块在其链增长时保持合理化，我们知道现在在时段 $u$，如 HLMD GHOST（算法 4.2）中定义的起始合理化配对 $(B_{J},j)$ 必须满足 $j\geq s$。由于 $s>r$，我们知道 $j>r$。

然而，由于算法 4.2 中的过滤 $L^{\prime}$，我们知道运行 HLMD GHOST（在时段 $u$）从 $(B_{J},j)$ 开始得到的叶区块 $B$ 必须满足 $(B_{J},j)\in J(\textsf{ffgview}(B))$。由于根据定义 $\mathsf{LJ}(B)\in J(\textsf{ffgview}(B))$ 且 $\mathsf{LJ}(B)=(B_{1},r)$，我们知道 $j\leq r$，矛盾。因此，协议不可能强迫诚实验证者违反 (S2)。

### 4.8 奖励与惩罚

验证者应因其提议的区块中包含有效的证明（在信标链规范 [11] 中称为*提议者奖励*）或因证明随着链增长而被合理化和最终确定的正确区块（在 [11] 中称为*证明者奖励*）而获得奖励（即权益增加）。同时，验证者应因违反罚没条件而受到惩罚（权益减少）。

奖励和惩罚的数量可以根据需要达到的安全级别进行调整，并且博弈论情境应该是激励验证者执行任务而不违反罚没条件。此外，值得考虑更复杂的激励机制，例如激励验证者抓住其他行为不当的验证者。虽然这可能导致有趣的博弈论工作，但添加对这些参数的分析层对于本文的范围来说是分散注意力的，我们希望专注于 Gasper 的共识方面。为了务实，我们通过假设这些奖励和惩罚机制提供了足够的博弈论激励，使得以下情况成立，从而将这一分析抽象掉：

*   诚实验证者遵循协议。
*   任何看到罚没条件被违反的诚实验证者都将罚没不诚实的验证者。

## 5 安全性

回想我们的主要目标是证明安全性和活跃性。在本节中，我们证明安全性，其证明方式与 Casper FFG [7] 类似；主要区别在于我们使用时段边界配对（而不是 Casper 的检查点区块），并且我们的最终确定定义更复杂。因此，我们需要以下引理，它必然比 Casper 中的对应思想更复杂。

**引理 5.1** 在视图 $G$ 中，如果 $(B_{F},f)\in F(G)$ 且 $(B_{J},j)\in J(G)$ 且 $j>f$，那么 $B_{F}$ 必须是 $B_{J}$ 的祖先，否则区块链是 $(1/3)$-可罚没的——具体来说，必须存在 $\mathcal{V}$ 的 $2$ 个子集 $\mathcal{V}_{1},\mathcal{V}_{2}$，每个的总权益至少为 $2N/3$，使得它们的交集全部违反罚没条件 (S1) 或全部违反罚没条件 (S2)。

*证明：* 预期矛盾，假设存在一个配对 $(B_{J},j)$，其中 $j>f$ 且 $B_{J}$ 不是 $B_{F}$ 的后代。根据最终确定的定义，在 $G$ 中，我们必须有 $(B_{F},f)\xrightarrow{1}(B_{k},f+k)$，其中我们有一系列相邻的时段边界配对 $(B_{F},f),(B_{1},f+1),\ldots,(B_{k},f+k)$。

由于 $(B_{J},j)$ 是合理化的且 $B_{J}$ 不是 $B_{F}$ 的后代，不失一般性（通过绝对多数链接回溯），我们可以假设 $(B_{J},j)$ 是最早的此类违规，意味着我们可以假设 $(B_{l},l)\xrightarrow{1}(B,j)$，其中 $l<f$ 但 $j>f$（这里我们使用引理 4.11，它告诉我们没有两个合理化区块具有相同的 $\mathsf{aep}(\mathsf{l})$，否则我们已经得到 $2$ 个各有权重 $2N/3$ 的验证者子集违反 (S1)；这就是为什么我们不担心相等的情况）。由于 $B_{1},\ldots,B_{k}$ 都是合理化的但是 $B_{F}$ 的后代，我们知道 $B_{J}$ 不能是这些区块中的任何一个，所以我们必须有 $j>f+k$。这意味着视图 $G$ 看到 $\mathcal{V}$ 的某个子集 $\mathcal{V}_{1}$ 的总权益超过 $2N/3$ 做出了合理化检查点边 $(B_{l},l)\to(B_{J},j)$ 的证明，因此对于任何此类证明 $\alpha_{1}$，$\mathsf{aep}(\mathsf{LJ}(\alpha_{1}))=l$ 且 $\mathsf{ep}(\alpha_{1})=j$。类似地，$G$ 也看到超过 $2N/3$ 权重的验证者 $\mathcal{V}_{2}$ 做出了合理化 $(B_{F},f)\to(B_{k},f+k)$ 的证明，因此对于任何此类证明 $\alpha_{2}$，$\mathsf{aep}(\mathsf{LJ}(\alpha_{2}))=f$ 且 $\mathsf{ep}(\alpha_{2})=f+k$。因此，对于交集 $\mathcal{V}_{1}\cap \mathcal{V}_{2}$ 中的任何人，他们做出了两种不同类型的证明：前者类型的 $\alpha_{1}$ 和后者类型的 $\alpha_{2}$。因为
$$l<f<f+k<j,$$
我们知道
$$\mathsf{aep}\left(\mathsf{LJ}\left(\alpha_{1}\right)\right)<\mathsf{aep}\left(\mathsf{LJ}\left(\alpha_{2}\right)\right)<\mathsf{ep}\left(\alpha_{2}\right)<\mathsf{ep}\left(\alpha_{1}\right),$$
这使得它们可以根据 (S2) 被明确罚没。

我们现在准备证明安全性。

**定理 5.2**（安全性）。在视图 $G$ 中，如果我们不具有以下性质，那么 $G$ 是 $(1/3)$-可罚没的。

1.  $F(G)$ 中的任何配对在视图更新时保持在 $F(G)$ 中。
2.  如果 $(B,j)\in F(G)$，那么 $B$ 在 $G$ 的规范链中。

*证明：* 第一个性质直接来自 $F(G)$ 和 $J(G)$ 的定义，因此我们省略证明。

算法 4.2 的定义表明，规范链总是通过具有最高证明时段 $j$ 的合理化配对，因此根据引理 5.1，必须通过 $F(G)$ 中最高的最终确定配对。因此，只需证明没有两个最终确定的区块冲突，因为那样所有最终确定的区块必须位于同一条链上，而这条链我们刚刚证明必须是规范链的子集。

我们现在证明，如果 $(B_{1},f_{1}),(B_{2},f_{2})\in F(G)$ 但 $B_{1}$ 和 $B_{2}$ 冲突，那么 $G$ 是 $(1/3)$-可罚没的。不失一般性，$f_{2}>f_{1}$。由于 $(B_{2},f_{2})$ 是最终确定的，它也是合理化的，我们可以应用引理 5.1。这表明要么 $B_{2}$ 必须是 $B_{1}$ 的后代（假设为不可能，因为它们冲突），要么 $G$ 是 $(1/3)$-可罚没的，正如所愿。

最后，为了从该定理得到我们最初的安全性概念，注意最终确定的区块的定义自动在未来的视图中持续存在。

## 6 合理活跃性

本节类似于 Casper FFG [7, 定理 2]。由于我们的设置更复杂（特别是算法 4.2 涉及更多），结果并不立即从先前的结果中得出，尽管具有相同的主要思想。

为此，我们给出一个辅助定义：给定一条链 $c=\operatorname{chain}(B)$ 和一个时段 $j$，如果 $\mathsf{LJ}(\mathsf{EBB}(B,j))=(B^{\prime},j-1)$ 对于某个区块 $B^{\prime}$，我们说 $c$ *在 $j$ 处是稳定的*。

**定理 6.1** 如果至少 $2N/3$ 权益的验证者是诚实的，那么无论区块链之前发生了什么，诚实验证者继续遵循协议，总是有可能最终确定一个新区块。

*证明：* 假设我们正在开始时段 $j$。具体来说，假设我们当前的时隙是 $i=Cj$；那么通过良好的同步性，所有人拥有相同的视图是合理的。特别是，提议者（合理地是诚实的）将提议一个时隙为 $i$ 的新区块 $B$，它是运行在旧视图上的 HLMD() 的输出区块的子区块。称这个当前视图（包括 $B$）为 $G$，并定义 $c=\operatorname{chain}(B)$。记住 $\operatorname{LEBB}(B)=B$；我们正在引入一个新的时段边界区块。

现在，我们声称，$c$ 扩展到下一个时段 $(j+1)$ 开始时的稳定链是合理的。为了看到这一点，注意由于至少 $2N/3$ 权益的验证者是诚实的，他们全部证明 $B$ 或其一个后代是合理的（例如，如果他们全部与网络视图同步并在 $B$ 创建后立即投票）。这创建了一个绝对多数链接 $\mathsf{LJ}(B)\xrightarrow{j}(B,j)$，合理化 $B$。现在，在下一个时段 $(j+1)$，具有时隙 $i+C=(j+1)C$ 的新区块 $B^{\prime}$ 包含所有这些证明是合理的（如果同步性好就会发生），因此 $\mathsf{LJ}(B^{\prime})=(B,j)$ 且 $\operatorname{chain}(B^{\prime})$ 在时段 $(j+1)$ 确实是稳定的。因此，通过假设良好的同步性和诚实验证者，无论区块链的初始状态如何，新时段的第一个时段边界区块的链是稳定的，这是合理的（可能不得不等待 $1$ 个额外的时段）。

因此，我们可以将分析简化为 $c$ 从一开始就是稳定的情况，这意味着我们在 $\textsf{ffgview}(B)$ 中有一个绝对多数链接 $(B^{\prime},j-1)\xrightarrow{j}(B,j)$。然后通过相同的逻辑，下一个时段边界区块（具有时隙 $(j+1)C$ 的 $B^{\prime\prime}$）也可能是稳定的，并有另一个绝对多数链接 $(B,j)\to(B^{\prime\prime},j+1)$。这将最终确定配对 $(B,j)$；特别是，它是 $1$-最终确定的特殊情况。

原始的 Casper FFG 是（假定为概率活跃的）区块链之上的一个“最终性小工具”，因此其重点不在于底层链的概率活跃性，而在于参与者不会陷入被迫罚没诚实验证者才能继续的境地。由于我们的论文也提供了底层协议，我们也希望有概率的活跃性保证，这将在第 7 节讨论。

## 7 概率活跃性

在本节中，我们在给定一些假设的情况下，证明第 4 节中主协议 Gasper 的概率活跃性。我们的证明包括以下步骤，这些基本上是定理 6.1 证明的主要思想：

1.  （假设导致首个时隙后的高权重）在“良好”条件下（如拥有足够的诚实验证者、同步性条件等，将形式化），诚实验证者有很大的概率在首个时隙后找到一个具有高权重的区块。
2.  （首个时隙后的高权重导致高概率合理化）如果我们在一个时隙后有一个高权重的区块，其相对于竞争者的权重“差”很可能在整个时段内增加，意味着该区块（或其后代）很可能被合理化。
3.  （高概率合理化导致高概率最终确定）如果每个时段都很有可能合理化一个区块，那么随着 $n$ 的增加，在 $n$ 个时段的连续时间内至少有一个区块被最终确定的可能性非常大。

这种划分不仅仅是组织性的；它还将假设封装到论证的不同部分，以便即使假设改变，每个部分仍然成立。例如，对应于第 3 项的主要定理，定理 7.5，不做任何同步性假设，仅依赖于一个区块被合理化的概率 $p$（尽管可能需要同步性假设来根据前几部分限定 $p$）。此外，我们在第二部分（正如我们在附录 B 的模拟中所做的那样）假设所有验证者拥有相同的权益，而第三部分则不需要。

本节是最复杂且依赖于参数的：一方面，当前规划的以太坊 2.0 实现实际上由于证明考虑延迟（见第 8.4 节）而规避了分析的非平凡部分；此外，界限假设每个验证者权益相等，这可能是一个有用的假设，也可能不是，取决于外部因素。然而，仍然值得对“纯粹”协议进行分析，因为这里的证明策略，例如使用集中不等式，可以非常普遍地适用于这一类潜在的基于时隙的权益证明方法，并且我们相信我们的分析抓住了这些方法在概率上起作用的本质。事实上，“补丁”，如前面提到的证明考虑延迟，主要是针对纯粹协议的攻击类型而存在的，因此为了建立直觉，解决这些攻击是有用的，即使实际实现规避了它们。因此，本节的主要价值是作为设计如 Gasper 这样的概率活跃协议所涉及分析的“概念验证”，而不是对实际实现的数学保证。

### 7.1 首个时隙后的高权重 - 模棱两可游戏

我们定义*模棱两可游戏*如下：

1.  游戏由 $(\mathcal{V},a,\epsilon_{1},\epsilon_{2})$ 参数化，其中 $\mathcal{V}$ 是验证者集合，$(a,\epsilon_{1},\epsilon_{2})$ 是参数化网络/同步性条件的实数（为便于阅读，我们将细节推至附录）。
2.  如同在 Gasper 中，$|\mathcal{V}|=N$，每个 $V\in \mathcal{V}$ 有一些固定的权益 $w(V)$。我们假设总权益为 $N$（因此平均权益为 $1$），并且诚实验证者的总权益至少为 $2N/3$。
3.  有 $2$ 个投票选项，我们简称为 $O_{1}$ 和 $O_{2}$。这些是对 Gasper 中 $2$ 个冲突区块进行投票的抽象，“区块”的概念不包含在这个模棱两可游戏中。如果 $O_{1}$ 或 $O_{2}$ 获得至少 $2N/3$ 权益的投票，我们（意为诚实验证者）*获胜*，否则我们输（即，我们处于模棱两可状态）。注意，这等价于游戏结束后两个选择之间存在 $N/3$ 的权益差的想法。

定义模棱两可游戏是为了捕捉 Gasper 在一个时隙内只有 $2$ 个选择的想法。活跃性所需的大多数必要假设都被编码到游戏中，以便本节中的其他活跃性结果尽可能独立。

在附录 B 中，我们详细说明了模棱两可游戏的细节，并在三种体制下（悲观体制、乐观体制和中间体制）进行了模拟。主要思想是，在“合理”的条件 $(\mathcal{V},a,\epsilon_{1},\epsilon_{2})$ 下，在第一个时隙之后，我们很可能赢得游戏，这意味着在 Gasper 中，我们应该期望其中一个配对在第一个时隙后获得 $2N/3$ 权益的支持。

从大局来看，概率活跃性的其余部分我们只需要模棱两可游戏我们“获胜”的想法（具体来说，在第一个时隙后有一个区块拥有比次优选项高得多的证明数量），概率为 $r$，并且更高的 $r$ 会增加区块将在定理 7.4 中被合理化的保证。出于实际目的，附录中的工作似乎表明，在不太强也不太弱的同步性条件下，大约 $80\%$ 的 $r$ 似乎是一个合理的启发式值，而这已经假设了接近 $1/3$ 的验证者不诚实的非常坏的情况。

**备注。** 显然，模棱两可游戏的概念可以推广，类似的游戏可用于研究其他权益证明模型。有许多方向（诚实验证者的协议、由比均匀分布更复杂的东西建模的延迟等）可能对未来工作有研究价值，但可能对我们论文的目的来说过于分散注意力。

### 7.2 首个时隙后的高权重导致合理化

在本节中，我们关注第 $j$ 个时段 $[T,T+C]$，其中 $T=jC$。令 $S=N/C$。我们定义以下假设集，称之为 $A(\epsilon)$：

*   网络从时间 $T=jC$ 开始是 $(1/2)-$同步的；
*   每个验证者有 $1$ 权益；
*   拜占庭验证者的总数等于 $N/3-C\epsilon$，意味着每个时隙委员会中拜占庭验证者的平均数量为 $S/3-\epsilon$。

对于每个 $i\in\{0,1,\ldots,C-1\}$，定义 $h_{i}$ 为时隙 $jC+i$ 中保证诚实的证明者数量，$b_{i}$ 为该时隙中不诚实的证明者数量。令 $S=N/C$，因此对于所有 $i$，$h_{i}+b_{i}=S$。我们使用无处不在的集中不等式证明，诚实/不诚实证明者的分布不应偏离期望太远：

**命题 7.1** 设 $\mathcal{X}=(x_{1},...,x_{N})$ 是一个有限列表，包含 $N$ 个值，满足 $a\leq x_{i}\leq b$，并设 $X_{1},...,X_{n}$ 是从 $\mathcal{X}$ 中无放回抽样得到的。以下成立：
$$\mathbb{P}\left(\sum_{i=1}^{n}X_{i}-n\mathbb{E}\left[X\right]\geq n\delta\right) \leq\exp\left(\frac{-2n\delta^{2}}{(1-(n-1)/N)(b-a)^{2}}\right)$$
$$\mathbb{P}\left(\sum_{i=1}^{n}X_{i}-n\mathbb{E}\left[X\right]\leq-n\delta\right) \leq\exp\left(\frac{-2n\delta^{2}}{(1-(n-1)/N)(b-a)^{2}}\right)$$

*证明：* 参见例如 [19]。

**命题 7.2** 假设满足假设 $A(\epsilon)$。假设 $C=2^{L}$。那么以下事件的合取（我们特意跳过 $h_{0}$）：
$$E_{1} :h_{1}\geq 2\cdot \frac{S}{3}$$
$$E_{2} :h_{2}+h_{3}\geq 2^{2}\cdot \frac{S}{3}$$
$$E_{3} :h_{4}+h_{5}+h_{6}+h_{7}\geq 2^{3}\cdot \frac{S}{3}$$
$$\ldots \vdots\ldots$$
$$E_{L} :h_{C/2}+\cdots+h_{C-1}\geq 2^{L}\cdot \frac{S}{3}$$
的概率为
$$\mathbb{P}\left(\bigcap_{i=1}^{L}E_{i}\right)\geq 1-\sum_{i=1}^{L}\exp\left(-\frac{2^{i}\epsilon^{2}}{\left(1-\frac{2^{i-1}S-1}{2^{LS}}\right)S}\right)\geq 1-\sum_{i=1}^{L}\exp\left(-\frac{2^{i}\epsilon^{2}}{S}\right).$$

*证明：* 我们使用超几何分布模型；即，我们考虑集合 $\mathcal{X}=(x_{1},\cdots,x_{N})$ 表示验证者 $\mathcal{V}$，其中如果第 $j$ 个验证者是诚实的，则 $x_{j}=1$，否则为 $0$。设 $X_{1},\ldots,X_{2^{i-1}S}$ 是从 $\mathcal{X}$ 中无放回抽取的 $2^{i-1}S$ 个样本。那么对于每个 $j$，$1\leq j\leq 2^{i-1}S$，$\mathbb{E}\left[X_{j}\right]=2/3+\epsilon/S$，所以：
$$\mathbb{E}\left[\sum_{j=1}^{2^{i-1}S}X_{j}\right] =2^{i-1}S(2/3+\epsilon/S)=2^{i}S/3+2^{i-1}\epsilon.$$
然后，我们可以将每个 $E_{i}$（作为 $X_{j}$ 的和）限定为
$$\mathbb{P}\left(\sum_{j=1}^{2^{i-1}S}X_{j}\geq 2^{i}\frac{S}{3}\right) =1-\mathbb{P}\left(\sum_{j=1}^{2^{i-1}S}X_{j}<2^{i}\frac{S}{3}\right)$$
$$=1-\mathbb{P}\left(\sum_{j=1}^{2^{i-1}S}X_{j}-\left(\frac{2^{i}S}{3}+2^{i-1}\epsilon\right)<-(2^{i-1}S)\frac{\epsilon}{S}\right)$$
$$\geq 1-\exp\left(-\frac{2^{i}\epsilon^{2}}{\left(1-\frac{2^{i-1}S-1}{2^{LS}}\right)S}\right),$$
其中最后一个不等式源于命题 7.1，回想 $N=2^{L}S$。当独立考虑每个事件 $E_{i}$ 时，其概率的下界由该值限定。对所有 $E_{i}$ 使用交集界限，我们得到期望陈述中的第一个不等式；通过比较分母，第二个不等式成立。

**备注：** 也可以使用例如以二项式模型（其中验证者被分配为诚实或拜占庭，有放回）的霍夫丁不等式。我们留给读者作为练习，这种方法立即得到较弱的界限：
$$\mathbb{P}\left(\bigcap_{i=1}^{L}E_{i}\right)\geq 1-\sum_{i=1}^{L}\exp\left(-\frac{2^{i}\epsilon^{2}}{S}\right).$$
虽然二项式模型只是一种近似，但有放回模型严格比无放回模型更趋向均值回归，因此这种近似对我们来说方向是正确的。这可以通过例如耦合方法使其严格化。我们使用较弱的界限是因为它在代数上更简洁，并且与更强的界限相比损失非常小。

可以看出，当 $\epsilon$ 在 $\sqrt{S}$ 的数量级时，命题 7.2 结果中的指数项相当小。例如，当 $C=64$（$2$ 的幂确实使命题 7.2 简洁地工作，尽管这肯定不是界限的关键部分）且因此 $S=900$，选择 $\epsilon=30$（意味着在 $57600$ 中最多有 $17280$ 个拜占庭验证者）给出的概率界限约为 $85\%$；将 $\epsilon$ 改为 $40$ 将概率跃升至约 $97\%$。

**引理 7.3** 假设满足 $A(\epsilon)$ 中的假设。那么，如果 view(NW, $T+C$) 合理化一个不在 $J(\text{view}(\text{NW},T))$ 中的新区块 $B$，$B$ 必须是 $J(\text{view}(\text{NW},T))$ 中最后一个合理化区块的后代。

*证明：* 回想诚实的证明者等待 $1/2$ 时间才对其指定的时隙进行证明。因此，在即将到来的时段 $j$，该时段所有诚实的证明者在时间段 $[T+1/2,T+C]$ 内进行证明。因为我们是 $(1/2)$-同步的，这意味着他们在此期间的所有视图都包括 view(NW, $T$)。根据算法 4.2 的性质，这意味着他们的所有区块提议和证明必须指向：
*   $B_{J}$（view(NW, $T$) 中最后一个合理化区块）的后代，或
*   在时段 $j$ 中合理化的某个新区块的后代。

我们的引理仅在第二种情况下失败，并且如果该时段的某个新区块获得该时段 $2/3$ 的证明。

幸运的是，鸡与蛋的问题对我们有利。拜占庭验证者有可能提议一个不是 $B_{J}$ 后代的新区块 $B^{\prime}_{J}$。然而，$B^{\prime}_{J}$ 不可能在这个时段获得足够的投票，因为根据算法 4.2，在 $B^{\prime}_{J}$ 被合理化之前的所有证明都必须指向 $B_{J}$ 的后代。因此，我们知道如果我们合理化一个新区块，它必须是 $B_{J}$ 的后代。

**定理 7.4**（合理化概率活跃性）。假设满足 $A(\epsilon)$ 中的假设，并且假设我们以概率 $r$ 赢得对应于第一个时隙的模棱两可游戏。设 $B_{J}$ 为 $J(\text{view}(\text{NW},T))$ 中最后一个合理化区块。那么，view(NW, $T+C$) 将以至少
$$r-\sum_{i=1}^{L}\exp\left(-\frac{2^{i}\epsilon^{2}}{S}\right)-\frac{1}{3^{C-1}}$$
的概率合理化 $B_{J}$ 的一个新的后代。

*证明：* 我们可以将这个时段的第一个时隙 $[T,T+1]$ 看作一个有 $S$ 个验证者（$h_{0}$ 个诚实，$b_{0}$ 个拜占庭）的模棱两可游戏，其中所有选项都是 $B_{J}$ 或其后代7。因此，以概率 $r$，其中一个选项在时隙 $jC$ 后获得至少 $2S/3$ 的证明。我们称这个获胜区块为 $B_{w}$（理想情况下，$B_{w}$ 就是区块 $jC$，尽管这不是必需的）。为了算法 4.2 中的加权，注意相对于模棱两可游戏中的任何其他选项，$B_{w}$ 的权重至少领先 $(2S/3-S/3)=S/3$。

Footnote 7: 技术上，选项是区块，而 $B_{J}$ 可能不是叶区块，但我们可以考虑在 $B_{J}$ 上构建的新区块作为选项。为了简单起见，我们在此忽略这个细节。

通过交集界限，我们以至少
$$r-\sum_{i=1}^{L}\exp\left(-\frac{2^{i}\epsilon^{2}}{S}\right)$$
的概率也满足命题 7.2 中的事件。我们现在证明，当这些事件被满足时，**时隙 $(jC+1),\ldots,(jC+C-1)$ 中所有剩余的诚实验证者都将投票给 $B_{w}$ 或其一个后代。**

考虑时隙 $jC+1$。由于 $E_{1}$，我们知道 $b_{1}<S/3$，因此即使所有 $b_{1}$ 个潜在的拜占庭行为者共谋投票给其他某个选项，到诚实验证者在时间 $(jC+1.5)$ 投票时，$B_{w}$ 的权重优势也不能被减小到 $0$。这意味着所有诚实验证者将继续证明 $B_{w}$ 或其后代区块（例如，时隙 $jC+1$ 的诚实提议者将提议区块 $jC+1$ 作为 $B_{w}$ 的后代）。根据 $E_{1}$，我们知道 $B_{w}$ 在该时隙获得至少 $2S/3$ 权重，而竞争对手区块最多获得 $S/3$ 权重，这意味着偏好 $B_{w}$ 的权重差变化了至少 $(2S/3-S/3)=S/3$。这意味着到时隙 $jC+1$ 结束时，$B_{w}$ 现在至少以 $S/3+S/3=2S/3$ 的权重领先。

现在考虑 $E_{2}$ 和下 $2$ 个时隙，$jC+2$ 和 $jC+3$。在它们之间，我们知道 $h_{2}+h_{3}<2S/3$，因此即使所有拜占庭行为者共谋，他们也无法破坏 $B_{w}$ 的领先优势，到这 $2$ 个接下来的时隙结束时，$B_{w}$ 将至少以 $(2S/3-2S/3+4S/3)=4S/3$ 的权重领先。

归纳地，这个逻辑对该时段所有剩余的时隙继续（具体来说，所有诚实验证者证明 $B_{w}$ 或其后代。这里算法 4.2 的结构很重要，因为虽然诚实的证明者可能（并且很可能会）证明新区块，但他们的证明权重也会加到 $B_{w}$ 的权重中。

因此我们得出结论，在所有剩余的时隙中，$B_{w}$ 累积了所有诚实验证者的证明。在时隙 $jC$ 之后，它以概率 $r$ 拥有至少 $2S/3$ 的投票。然后，我们知道它获得了至少 $h_{1}+h_{2}+\cdots+h_{C-1}$ 的权重，总权重为
$$\frac{2}{3}S+\sum_{i=1}^{L}\frac{2^{i}}{3}S=\frac{2}{3}S+\frac{2}{3}\left(2^{L}-1\right)S=\frac{2^{L+1}}{3}S=\frac{2}{3}N,$$
因此我们确实获得了足够的权重以形成绝对多数链接。

为了证明 $B_{J}$ 与 $B_{w}$ 不同，我们需要至少一个诚实验证者在时段 $\mathsf{aep}(B_{w})$ 中或之前提议一个在 $B_{J}$ 之上的新区块。由于 $B_{J}$ 在时段 $\mathsf{aep}(B_{j})$ 获得超过 $\frac{2}{3}$ 的投票，在 $\mathsf{aep}(B_{j})$ 中有超过 $\frac{2}{3}$ 的诚实验证者。那么**没有**诚实验证者在 $\mathsf{aep}(B_{j})$ 中在 $B_{J}$ 之上提议区块的概率上界为 $(\frac{1}{3})^{C-1}$，这个值极小。

### 7.3 概率合理化导致概率最终确定

主要定理如下：

**定理 7.5**（最终确定概率活跃性）。假设每个时段合理化一个区块（如命题 7.2 所述）的概率独立地为 $p\geq 1/2$，则在接下来的 $n$ 个时段内未能最终确定一个区块的概率作为 $n$ 的函数指数趋近于 $0$。

*证明：* 回想我们期望大多数最终确定是 $1$-最终确定，即一个合理化区块合理化一个相邻的时段边界区块。对于这个证明，只需要证明甚至未能 $1$-最终确定的概率趋近于 $0$。

我们考虑一个“成功”的时段，如果该时段中一个区块被合理化，否则为“失败”。因此，如果 $2$ 个相邻时段“成功”，我们就最终确定一个区块。因此，在接下来的 $n$ 个时段内没有得到一个（$k=1$）最终确定的概率是接下来的 $n$ 个时段中没有 $2$ 个相邻时段成功的概率。使用独立性假设，其概率为
$$\sum_{i\geq \frac{n}{2}}^{n}\binom{i+1}{n-i}(1-p)^{i}p^{n-i},$$
因为对于一个特定的 $i\geq n/2$，有 $\binom{i+1}{n-i}$ 种方式选择 $i$ 个失败。

由于 $p\geq 0.5$，我们知道 $p\geq (1-p)$，所以该和的上界为
$$\left(\sum_{i=n}^{\left\lfloor\frac{n}{2}\right\rfloor}\binom{i+1}{n-i}\right)(1-p)^{n/2}p^{n/2}$$
众所周知（例如通过归纳法）：
$$\sum_{i=n}^{\left\lfloor\frac{n}{2}\right\rfloor}\binom{i+1}{n-i}=\binom{n+1}{0}+\binom{n}{1}+\binom{n-1}{2}+\cdots=F_{n},$$
即第 $n$ 个斐波那契数，我们知道其形式为
$$F_{n}=\frac{1}{\sqrt{5}}\left[\frac{(1+\sqrt{5})}{2}\right]^{n}-\frac{1}{\sqrt{5}}\left[\frac{(1-\sqrt{5})}{2}\right]^{n}$$
当 $n\to\infty$ 时，第二项消失，因此我们期望的量上界为（乘以一个常数）
$$\left[\frac{(1+\sqrt{5})\ \sqrt{p\left(1-p\right)}}{2}\right]^{n}$$
我们有界限 $\sqrt{p\left(1-p\right)}\leq 1/2$（例如，通过 AM-GM 不等式），因此失败率的上界为
$$\frac{1}{\sqrt{5}}\left(\frac{1+\sqrt{5}}{4}\right)^{n},$$
当 $n\to\infty$ 时趋近于 $0$。最后，回想我们只关注 $1$-最终确定，因此最终确定的几率严格更高（尽管在实践中其他类型的最终确定应该很少发生）。

图 7：我们在 $n=5$ 个时段中有 $3$ 个失败时段**未能**最终确定区块的情况。“S”表示成功，“F”表示失败（关于命题 7.2）。

定理 7.5 对合理化概率 $p$ 以及我们如何获得它“不可知”。这意味着如果我们调整协议、改变假设等，并从当前的定理 7.4 获得不同界限/估计的 $p$，我们的结果仍然成立。因此，我们将 $p$ 作为定理 7.5 的**输入**，而不是重用我们在定理 7.4 中的实际界限。抽象掉合理化活跃性的次要效果是**这些技术可用于证明一般 $2$ 阶段协议的最终确定概率活跃性，而不仅仅是** Gasper（甚至可以轻松扩展到具有 $3$ 个或更多阶段的协议，尽管界限会不同）。无论协议如何，随着 $n$ 的增加，只要 $p\geq 0.5$，最终确定区块的概率迅速增加，即使在 $p=0.5$ 的情况下，经过 $n=20$ 个时段后也达到约 $99\%$。参见表 1 中的一些计算。

**备注**（与合理活跃性的关系）。从技术上讲，我们可能感觉从概率活跃性中“免费”得到了合理活跃性。那么为什么我们在本文中分开对待它们呢？

一方面，合理活跃性是协议 Gasper 规则的直接结果，需要很少的假设，而概率活跃性依赖于概率假设（如网络同步性），并且对协议的细微变化更脆弱。特别是，我们的概率活跃性处理做了一个非常强的假设，即所有验证者拥有相同的权益。因此，我们选择单独呈现合理活跃性，以强调即使这些假设在“现实生活”中不满足，合理活跃性仍然存在。

另一方面，合理活跃性的重点是“诚实验证者永远不会被协议要求自愿罚没自己以继续”，而概率活跃性的重点是“新区块很可能被快速合理化/最终确定”；这些是不同的要点。

## 8 实践与理论

以太坊 2.0 在 [11] 中的实际实现包含了与 Gasper 不同的设计决策，Gasper 旨在成为一个“干净”且数学上更易处理的协议，捕捉信标链设计的理论核心。在本节中，我们考虑拟议实现与 Gasper 的差异，而不陷入对所有这些细节组合的严格研究所需要的更混乱的分析。

### 8.1 分片

Gasper 的动机来自以太坊 2.0 *信标链*，它是以太坊 2.0 设计中存储和管理验证者注册表的“主”区块链。在此实现中，一个*验证者*是信标链中的注册参与者。个人可以通过将以太币发送到以太坊 1.0 存款合约来成为信标链的验证者。如同在 Gasper 中，验证者在信标链中创建并证明区块。证明同时是对信标区块的权益证明投票（如我们的设计），也是对包含不同“分片链”中数据的“分片区块”的可用性投票。*分片*的概念产生了我们论文范围之外的有趣的工程和数学问题，我们仅限于信标链。

### 8.2 实现视图

在 Gasper 中，我们可以将视图和相关概念视为抽象的数学概念，将验证者视为具有无限计算能力的完美推理代理。在实践中，验证者不会直接使用视图的图形数据结构进行推理；相反，他们将使用软件来解析提供给他们的视图并遵循协议。因此，在实际实现 [11] 中，验证者运行一个更新“存储”的程序，该存储基本上是视图的表示。作为 LMD GHOST 分叉选择规则输入的存储，在接收到区块或证明时更新。

显然，在解释这些结构及其更新时出错可能导致与 Gasper 本身无关的安全性和活跃性问题。尽管在我们的工作中，我们将分析限制在协议的数学部分，但我们提醒读者这些问题也很重要；软件层面由于粗心实现协议而产生的安全漏洞不受 Gasper 数学保证的保护。

### 8.3 证明包含延迟

在 Gasper 中，当验证者提议一个区块时，他/她包含其视图中的所有新证明。在规划的实现中，有一个*证明包含延迟*的整数参数（比如 $n$），使得当验证者提议一个区块时，他/她只包含至少 $n$ 个时隙前所做的证明。

证明包含延迟的目的是防止中心化和奖励优势。如果时隙长度“短”（意味着对于网络中的普通节点，证明传播的延迟很高），那么高度连接的节点可能能够更快地获得证明数据并能够更快地发布它们，这可能根据奖励激励对应各种优势。

强制延迟允许证明在被包含进区块之前更广泛地传播。因此，节点有更平等的机会捕获提议区块的证明包含奖励。计划是根据现实世界的网络数据调整证明包含延迟（在 1 到 4 个时隙的范围内）。较小的值提高了交易处理速度，较大的值提高了去中心化。注意增加时隙时间是促进去中心化的另一种方法。

### 8.4 证明考虑延迟

在 Gasper 中，当验证者应该在时隙 $N$ 进行证明时，验证者运行 HLMD GHOST 分叉选择规则时考虑其视图中的所有证明。在规划的实现中，他/她只考虑至少 $1$ 个时隙旧的证明。具体来说，用作分叉选择规则输入的视图包含截至时隙 $N$ 的所有有效区块，但只包含截至时隙 $N-1$ 的所有有效证明。

这一时隙延迟保护验证者免受一类特定的时间攻击，在这类攻击中，拜占庭验证者急切地广播时隙 $N$ 的证明，而不是等待他们“应该”证明的 $N+1/2$ 时间。这使得他们能够理论上利用网络延迟来分裂诚实验证者的投票，使链保持模棱两可状态。这是一个需要应对的重要攻击，因为在区块中在“错误”时间发布证明并不是可罚没的违规行为（因为对手理论上可以伪造时间戳，并且我们没有假设 Gasper 具有使伪造时间戳更难的机制）。

我们在*模棱两可游戏*的分析中（见附录 B）涵盖了这种一次性延迟攻击，并得出结论，在非常悲观的体制下，该攻击很可能有效。然而，如果我们实现类似证明考虑延迟的东西，即使在悲观体制下，拜占庭验证者在这种特定类型攻击中成功的概率也大大降低。

具体来说，这种延迟改善了定理 7.4 中分析的概率活跃性的参数。只要诚实验证者被选中提议一个区块（在最坏情况下概率至少为 $2/3$）$B$，那么所有诚实验证者都会在第一个时隙投票给 $B$，因为他们将忽略第一个时隙中做出的所有证明，包括不诚实验证者做出的证明。换句话说，证明考虑延迟中和了第一个时隙的模棱两可游戏作为一个攻击点，意味着拟议实现中的概率活跃性甚至比原始 Gasper 有更好的保证。对这种设置的概率活跃性的严格分析可能成为有趣的未来工作。

### 8.5 四案例最终确定规则

虽然 Gasper 的定义 4.9 捕捉了最终确定数学思想的“通用”版本，但拟议的实现出于实用性考虑，仅使用查看最近 $4$ 个时段的“简化”版本。具体来说，令 $B_{1},B_{2},B_{3},B_{4}$ 为连续时段的时段边界区块，其中 $B_{4}$ 是最新的时段边界区块。

1.  如果 $B_{1},B_{2}$ 和 $B_{3}$ 是合理化的，并且合理化 $B_{3}$ 的证明 $\alpha$ 有 $LJ(\alpha)=B_{1}$，我们最终确定 $B_{1}$。
2.  如果 $B_{2},B_{3}$ 是合理化的，并且合理化 $B_{3}$ 的证明 $\alpha$ 有 $LJ(\alpha)=B_{2}$，我们最终确定 $B_{2}$。
3.  如果 $B_{2},B_{3}$ 和 $B_{4}$ 是合理化的，并且合理化 $B_{4}$ 的证明 $\alpha$ 有 $LJ(\alpha)=B_{2}$，我们最终确定 $B_{2}$。
4.  如果 $B_{3},B_{4}$ 是合理化的，并且合理化 $B_{4}$ 的证明 $\alpha$ 有 $LJ(\alpha)=B_{3}$，我们最终确定 $B_{3}$。

这些是定义 4.9 对于 $k=1$（前两种）和 $k=2$ 情况的特例。这里的想法是以太坊 2.0 将只接受最多 $2$ 个时段的证明。这意味着最多 $2$ 个时段前的时段边界区块可以被新合理化（从而被最终确定），这给出了 $4$ 种情况。参见图 8。

图 8：从左到右，分别是案例 1 到 4 的示例。红色和蓝色都表示合理化区块，其中蓝色区块由于观察到的合理化（由双箭头表示）现在被最终确定。

### 8.6 安全性 - 动态验证者集合

在 Gasper 的安全性分析（第 5 节）中，我们假设了*静态*验证者集合，意味着验证者集合不能随时间改变。回想我们的主要结果，定理 5.2，告诉我们如果安全性被破坏，我们能够抓住价值 $N/3$ 权重的违反罚没条件的验证者。然而，在实践中，我们希望支持*动态*验证者集合，这意味着验证者被允许*激活*（进入）和*退出*验证者集合 $V$。这意味着拜占庭激活者可以行为恶意，然后退出以避免其权益被罚没。这种设置减少了我们可以因违反罚没条件而惩罚的“活跃”验证者的数量。

**定义 8.1** 假设有 $2$ 个验证者集合，$\mathcal{V}_{1}$ 和 $\mathcal{V}_{2}$，其中 $\mathcal{V}_{2}$ 是比 $\mathcal{V}_{1}$ 更晚时间的验证者集合。我们定义 $A(\mathcal{V}_{1},\mathcal{V}_{2})$，即*激活（从 $\mathcal{V}_{1}$ 到 $\mathcal{V}_{2}$）*的验证者，为不在 $\mathcal{V}_{1}$ 中但在 $\mathcal{V}_{2}$ 中的验证者集合；$E(\mathcal{V}_{1},\mathcal{V}_{2})$，即*退出（从 $\mathcal{V}_{1}$ 到 $\mathcal{V}_{2}$）*的验证者，为在 $\mathcal{V}_{1}$ 中但不在 $\mathcal{V}_{2}$ 中的验证者集合。

首先，我们注意到第 5 节的关键思想仍然成立：

**引理 8.2** 假设我们允许动态验证者集合。在视图 $G$ 中，如果 $F(G)$ 中的 $(B_{1},f_{1})$ 和 $(B_{2},f_{2})$ 冲突，那么区块链必须是 $(1/3)$-可罚没的。具体来说，必须存在 $G$ 中的 $2$ 个合理化配对 $(B_{L},j_{L})$ 和 $(B_{R},j_{R})$，以及 $2$ 个子集 $\mathcal{V}_{1}\subset \mathcal{V}(B_{L}),\mathcal{V}_{2}\subset \mathcal{V}(B_{R})$，每个的权重至少是其对应证明时段权益的 $2/3$，使得它们的交集 $\mathcal{V}_{1}\cap \mathcal{V}_{2}$ 违反 (S1) 或 (S2)。

*证明：* 证明本质上与引理 5.1 以及定理 5.2 到它的约简相同。唯一的区别是我们必须将引理 5.1 的条件重新表述为关于它们证明时验证者集合的条件。

如同在定理 5.2 的证明中，如果我们有 $2$ 个冲突的区块 $(B_{1},f_{1})$ 和 $(B_{2},f_{2})$，那么要么 $f_{1}=f_{2}$，要么 $f_{1}\neq f_{2}$。如果 $f_{1}=f_{2}$，那么我们可以设 $(B_{L},j_{L})=(B_{1},f_{1})$ 和 $(B_{R},j_{R})=(B_{2},f_{2})$ 来满足我们的断言，因为它们的交集违反 (S1)。如果 $f_{1}\neq f_{2}$，不失一般性，$f_{1}<f_{2}$。由于 $(B_{2},f_{2})$ 是最终确定的，它也是合理化的，并且我们现在满足引理 5.1 的设定，其中 $(B_{F},f)=(B_{1},f_{1})$ 和 $(B_{J},j)=(B_{2},f_{2})$。应用该引理，我们得出结论，要么 $B_{2}$ 是 $B_{1}$ 的后代（矛盾，因为它们冲突），要么必须存在一些配对（不一定是 $(B_{F},f)$ 或 $(B_{J},j)$ 本身），其每个的证明都有 $2N/3$ 权益，并且其交集违反 (S1) 或 (S2)。

我们现在呈现我们的主要定理。主要思想是首先取一个在“参考时间”发布的区块 $B_{0}$（最自然地，我们可以取冲突区块的共同父区块，但这个选择不是必须的），其具有“参考验证者集合” $\mathcal{V}_{0}$。然后，我们可以上界定在合理化区块 $B_{L}$ 和 $B_{R}$（来自引理 8.2）的验证者集合与 $\mathcal{V}_{0}$ 之间的激活和退出的总权重，作为自参考时间以来经过时间的函数。这允许我们下界定这些区块的法定人数的可罚没交集的大小。

**定理 8.3** 假设我们有一个视图 $G$，其中包含两个冲突的最终确定区块，那么 $G$ 有足够的证据来罚没总权益至少为
$$\max(w(\mathcal{V}_{L})-a_{L}-e_{R},w(\mathcal{V}_{R})-a_{R}-e_{L})-w(\mathcal{V}_{L})/3-w(\mathcal{V}_{R})/3$$
的验证者，其中

1.  存在一个区块 $B_{0}\in G$，具有验证者集合 $\mathcal{V}_{0}$；
2.  区块 $B_{L}$ 和 $B_{R}$ 由引理 8.2 存在，分别具有验证者集合 $\mathcal{V}_{L}$ 和 $\mathcal{V}_{R}$。
3.  $a_{L}=w(A(\mathcal{V}_{0},\mathcal{V}_{L}))$ 且 $e_{L}=w(E(\mathcal{V}_{0},\mathcal{V}_{L}))$；类似定义 $a_{R}$ 和 $e_{R}$。

*证明：* 根据假设，两个（未命名的）冲突的最终确定区块通过引理 8.2 产生了 $B_{L}$ 和 $B_{R}$，而 $B_{L}$ 和 $B_{R}$ 又分别有法定人数 $Q_{L}\subset \mathcal{V}_{L}$ 和 $Q_{R}\subset \mathcal{V}_{R}$，两者都至少有其对应验证者集合 $V_{L}$ 和 $V_{R}$ 权益的 $2/3$。

我们表示由我们的 $3$ 个验证者集合重叠创建的不同集合为 $A,B,C,D,E,F,G$，如图 9 所示。

图 9：初始验证者集合 $\mathcal{V}_{0}$ 和两个验证者集合 $\mathcal{V}_{L}$ 与 $\mathcal{V}_{R}$ 的维恩图，字母 A 到 G 形象地表示每个重叠中有多少验证者。

接下来，我们希望界定法定人数 $Q_{L}$ 和 $Q_{R}$ 的交集，如图 10 所示。设 $\mathcal{V}_{LR}=\mathcal{V}_{L}\cap \mathcal{V}_{R}=C\cup F$，我们有：
$$w(Q_{L}\cap Q_{R}) \geq w(Q_{L}\cap \mathcal{V}_{LR})+w(Q_{R}\cap \mathcal{V}_{LR})-w(C\cup F)$$
$$\geq 2w(\mathcal{V}_{L})/3-w(B\cup E)+2w(\mathcal{V}_{R})/3-w(D\cup G\cup C\cup F)$$
$$=2w(\mathcal{V}_{L})/3+2w(\mathcal{V}_{R})/3-(w(B\cup C\cup D\cup E\cup F\cup G))$$
$$=w(C)+w(F)-w(\mathcal{V}_{L})/3-w(\mathcal{V}_{R})/3.$$

令 $X=w(C)+w(F)$。我们知道
$$X =w(\mathcal{V}_{L})-w(B\cup E)$$
$$\geq w(\mathcal{V}_{L})-w(A\cup B\cup E\cup F)$$
$$=w(\mathcal{V}_{L})-a_{L}-e_{R},$$
类似地，
$$X \geq w(\mathcal{V}_{R})-a_{R}-e_{L}.$$

图 10：法定人数 $Q_{L}$ 和 $Q_{R}$ 在冲突区块 $B_{L}$ 和 $B_{R}$ 之间有重叠的验证者。

作为完整性检查，注意在无退出或激活的极端情况下，所有 $a$ 和 $e$ 都为零，因此我们恢复了原始界限 $w(\mathcal{V}_{L})/3=N/3$。此外，我们可以通过例如使用 $X$ 的两个界限的线性组合来避免负号，得到界限
$$w(\mathcal{V}_{L})/3-(2a_{L}/3+2e_{R}/3+a_{R}/3+e_{L}/3).$$
界限的效力取决于我们关于激活和退出的策略。假设 $B_{0}$（“参考区块”）在时间 $T_{0}$ 发布，而 $B_{L}$ 和 $B_{R}$ 在 $T_{now}$ 发布（更准确地说，我们应定义 $T_{now}$ 为两个区块发布时间的最大值）。那么我们可以将 $a_{*}$ 和 $e_{*}$ 控制为时间差和策略的函数。以下是一些示例和观察：

*   如果我们允许每个时段有恒定权益 $k$ 的新验证者激活，那么我们可以限定
    $$a_{L},a_{R}\leq k\left(T_{now}-T_{0}\right).$$
    我们可以对退出做同样的事情，并在同一协议中可能用不同的常数获得 $e_{L}$ 和 $e_{R}$ 的界限。
*   如果我们允许激活与验证者权益成比例，例如，每个时段最多可以激活 $k\cdot w(\mathcal{V})$，那么界限变为指数级：
    $$a_{L},a_{R}\leq w(\mathcal{V})(1+k)^{T_{now}-T_{0}};$$
    在极限情况下，这成为指数界限。
*   随着 $T_{now}$ 和 $T_{0}$ 之间的差异变长，$w()$ 项会变大，界限变得不那么有用，右侧最终变为负数。这是不可避免的；可以想象一个“忒修斯之船”的情况，验证者集合已经完全改变，在这种情况下，不可能罚没系统中的任何人。
*   界限也可以处理延迟；如果我们准备最多 $\delta$ 时间的延迟，那么我们实际上在计算 $(T_{now}-T_{0})$ 出现的地方的 $a$ 和 $e$ 的界限中加上 $\delta$，然后我们可以将其反馈回定理 8.3。

这些界限显示了**区块链进入和退出的灵活性与抓住恶意行为者的能力之间的权衡**。我们的静态结果，定理 5.2，有直观含义“如果我们的协议破坏了安全性，我们可以明确罚没 $1/3$ 权重的验证者”，以暗示只要我们对验证者有足够强的信任，我们的协议是安全的。我们的动态结果，定理 8.3，具有更细微的形式“如果我们的协议破坏了安全性，那么只要攻击者无法创建具有长分支长度的分叉，我们可以明确罚没略少于 $1/3$ 权重的验证者。”这意味着纯 Gasper 容易受到诸如恶意行为者关闭整个网络许多8个时段然后突然出现一个冲突分叉的攻击，使得我们无法罚没太多权益的验证者，因为他们在此期间已经退出。这种情况在实践中可以通过简单地不将旧的证明包含到视图中来防范；例如，当前的以太坊 2.0 规范不接受 $2$ 个或更多时段的证明，从而避免了这种攻击。

Footnote 8: 作为参考，在具体协议中，给定以太坊实现中的排队机制，大约需要 $2.5$ 个月才能周转 $1/3$ 的验证者集合，这大约是 $20000$ 个时段的数量级。

### 8.7 极端情况；硬分叉

尽管我们在有 $\frac{2}{3}$ 多数诚实权益持有者的情况下具有相当无条件的合理活跃性，并且在“良好”条件下具有概率活跃性，但考虑最坏情况场景很重要。在由于大量*非活跃*（不参与）验证者（不一定恶意，因此不被罚没）导致长时间分叉和缺乏最终性的情况下，以太坊 2.0 信标链有一种机制，通过这种机制，分叉上的*活跃*（参与）验证者保留其权益，而非活跃验证者“流失”权益，使得活跃验证者最终在几周的时间量级内成为 $\frac{2}{3}$ 多数。这种情况可能发生在例如全球互联网被分割，$50\%$ 的验证者在一侧，$50\%$ 在另一侧的情况下。

另一种极端情况是一条链连续“摇摆”，使得没有明显的分割，相反，多数派只是每个时段不断切换分叉。对于这种情况或更严重情况的最终备用计划是进行*硬分叉*（或*手动分叉*），即运行区块链的社区选择更改共识规则的点（著名的此类案例包括比特币 vs. 比特币现金，或 ETH vs. ETH 经典）。这可能是由于升级或添加功能、修复生产中的关键问题，或应对分裂的社区或政治分裂。通常，这导致从区块链的某个特定点开始运行一组新的协议规则。这是一个重要的工程问题，同样超出了我们的数学范围，即状态转换和分叉选择函数可以平稳地处理这些变化。在大多数考虑中，HLMD GHOST 分叉选择规则将保持不变。然而，当更改深入逻辑内部时，将不得不考虑超出内置分叉机制的因素，并且可能会实现手动分叉。

## 9 结论

我们提出了一个抽象协议 Gasper，它结合了 LMD GHOST 和 Casper FFG，用于一个完整的基于权益证明的区块链设计。这是 Casper FFG 到一个完整区块链协议的首次正式概念验证。我们的目标是将以太坊 2.0 设计的“数学上干净”部分与实现细节分开。一些分析技术足够通用，可用于研究其他协议，例如概率活跃性的证明和模棱两可游戏的构建。在实践中，分析中的许多最坏情况世界可以通过第 8 节中的想法进行修补。

为了透明，重要的是要注意，“补丁”甚至“实现细节”有可能改变安全性/活跃性假设，甚至两个原本无害的“补丁”可能以不良方式组合。然而，无法预测协议最终将收到的所有潜在实现更改，也无法预测当前提议的补丁中哪些会因可能无关的原因被包含在实现中或从中移除。因此，我们撰写本文以分析协议的主要理论基础，并且我们只是简单地将每个实现细节的分析作为一个孤立的更改进行概述，而不是与其他细节结合进行。随着协议的巩固，可能通过现实测试，重新评估将成为协议“核心”的补丁的效果将是有意义的。特别是，某种版本（可能与我们提出的版本有显著不同）的动态验证者集合将是不可或缺的；一旦其设计最终确定，重新审视其对安全性/活跃性的影响将很重要。

加密货币领域存在许多其他基于权益证明的协议。一些例子包括：

*   Tendermint [4]：一个非常“纯粹”的设计，是应用于区块链权益证明背景的 PBFT 简化。该设计偏爱安全性胜过活跃性。所有验证者参与每一轮共识，没有共识比这些轮次更快发生，只有 $\geq 2/3$ 权益的验证者在线时才能取得进展。
*   Casper CBC [5]：Casper FFG 的替代提案，专注于通过构造实现数学正确性。Casper CBC 没有固定的协议内阈值，基于节点遵循其他节点过去所做多数行为并对区块做出最终性推断的涌现方法。除了作为提议的协议，Casper CBC 也旨在成为分析共识设计的通用框架。
*   Hotstuff (v6) [21]：具有许多与 Casper FFG 相似的特性，具有灵活的数学框架；一个关键区别是 Hotstuff 使用指数退避机制，以便能够在任意网络延迟下取得进展。
*   Ouroboros [14]：属于“同步”学派的协议，假设同步性以实现容错（因此获得更强的 $50\%$ 容错界限）。它使用最长链规则和奖励机制来激励参与并防止被动攻击。在 Ouroboros Praos [14] 中，协议被更新以应对针对“消息延迟”攻击的漏洞。在 [1] 的 Ouroboros Genesis 中，协议进一步扩展，允许参与者从创世区块引导共识（因此得名），证明了对 $50\%$ 对手的全局通用可组合（GUC）安全性。
*   Snow White [9]：一种协议，其中委员会领导者可以扩展区块链，区块包含对前一个区块的引用（类似于区块依赖项），以及一个可用于根据某个先验难度常数验证区块有效性的随机数。有效的时间戳必须增加，“未来的任何时间戳将导致链被拒绝”。参与者只接受在过去没有被修改太远的传入链，类似于在一定数量的时段内接受视图。
*   Nxt [16]：一种具有有限数量代币的权益证明协议。Nxt 使用基于权益的概率来获得生成区块的权利，但由于不生成新代币，它征收交易费以流通货币。Nxt 将自己与 Peercoin 对比，指出 Peercoin 的算法赋予在网络中长时间持有代币的矿工更多权力。该协议还描述了区块创建和转移代币的某些限制，以防止标准攻击和在账户之间转移权益。
*   Thunderella [18]：一种权益证明协议，旨在实现相对于消息延迟的最优交易验证，假设“良好条件”，即委员会领导者是诚实的且拥有绝对多数的诚实验证者。在停滞的情况下，将实施新的领导者在备用网络上构建。该协议还允许具有冷却期的动态验证者。
*   Dfinity [12]：与工作量证明和权益证明都工作的信标公证协议。该系统使用随机信标选择区块提议者，去中心化的公证人根据 [12] 中描述的标准选择排名最高的区块。他们*验证者*和*委员会*的类比分别称为*副本*和*组*，去中心化的公证人依赖相同的拜占庭容错来公证区块并达成共识。他们只有被动的最终确定概念，但公证过程相当快，并且区块确实及时发布。副本确实需要许可才能离开链。

我们的目标不是显示我们的设计严格优于这些其他设计中的任何一个。所有这些协议都包含基于不同设计目标和网络假设的权衡。我们的设计以简单性、可理解性和实用性之间的平衡为指导，混合强调安全性和活跃性。例如，如果提议的区块链上下文优先考虑安全性而非速度，那么人们可能，例如，选择或修改更倾向于 Tendermint 方向的提案。

## 致谢

我们感谢以太坊基金会和圣何塞州立大学研究基金会对本项目的支持。这个项目得益于 SISU 数学与统计系的 CAMCOS（应用数学、计算与统计中心）计划。我们还要感谢 Aditya Asgaonkar, Carl Beekhuizen, Dankrad Feist, Brian Gu, Brice Huang, Ryuya Nakamura, Juan Sanchez, Yi Sun, Mayank Varia 和 Sebastien Zany 的有益评论。我们感谢 Runtime Verification (Musab Alturki, Elaine Li, Daejun Park) 的有益评论以及在 Coq 中的证明验证，这项工作建立在 Karl Palmskog, Lucas Pena 和 Brandon Moore 的工作基础上。作者 Yan X Zhang 是 CAMCOS 的主任；作者 Vitalik Buterin 和 Danny Ryan 是以太坊基金会的成员。

## 参考文献

[参考文献列表已省略以节省篇幅，但论文原文中包含]