# Uniswap v3 实际计算示例详解

## 示例1：ETH/USDC 交易对完整流程

### 1. 初始设置

**交易对参数：**
```javascript
交易对: ETH/USDC
token0: USDC (6位小数)
token1: ETH (18位小数)
当前价格: 2000 USDC/ETH
费率: 0.30% (γ = 0.003)
协议费率: 0 (φ = 0)
```

**价格与 Tick 设置：**
```javascript
当前价格: P = 2000
当前√P: √2000 ≈ 44.72135955

Tick 系统: P(i) = 1.0001^i
当前 tick: i_c = floor(log₁.₀₀₀₁(2000)) ≈ 76009

流动性提供区间: [i_l, i_u] = [75000, 77000]
对应价格范围: 
  P(i_l) = 1.0001⁷⁵⁰⁰⁰ ≈ 1806.74 USDC/ETH
  P(i_u) = 1.0001⁷⁷⁰⁰⁰ ≈ 2213.55 USDC/ETH
```

### 2. 流动性提供阶段

**流动性提供者存入：**
```javascript
存入: 2 ETH + 4000 USDC

计算边界价格平方根：
√P(i_l) = √1806.74 ≈ 42.506
√P(i_u) = √2213.55 ≈ 47.049
√P = √2000 ≈ 44.721
```

**计算流动性数量 L：**
```javascript
从 ETH 数量计算 ΔL：
ΔL = ΔY / (√P - √P(i_l)) = 2 / (44.721 - 42.506) = 2 / 2.215 ≈ 0.903

验证 USDC 数量：
ΔX = 0.903 × (1/44.721 - 1/47.049) 
   = 0.903 × (0.02236 - 0.02125) 
   = 0.903 × 0.00111 ≈ 0.00100

实际 USDC 数量: 0.00100 × 10⁶ = 1000 USDC
```

**结果：**
```
流动性提供者存入 2 ETH + 1000 USDC，获得流动性 L = 0.903
```

### 3. 交易阶段

**交易者进行交换：**
```javascript
交易者用 5000 USDC 购买 ETH

步骤1: 计算净投入
交易费 = 5000 × 0.003 = 15 USDC
净投入 Δy = 5000 - 15 = 4985 USDC

步骤2: 计算价格影响
Δ√P = Δy / L = 4985 / 0.903 ≈ 5520.49
新 √P' = √P + Δ√P = 44.721 + 5520.49 = 5565.211

步骤3: 检查是否跨越 tick
检查新 tick: i_c' = floor(log₁.₀₀₀₁(5565.211²)) 
            = floor(log₁.₀₀₀₁(30971562)) 
            ≈ 92563

由于 92563 > i_u (77000)，价格已超出流动性提供者的区间
```

**分段执行交换：**
```javascript
第一部分: 从当前价格到上界
Δ√P₁ = √P(i_u) - √P = 47.049 - 44.721 = 2.328
消耗的 Δy₁ = Δ√P₁ × L = 2.328 × 0.903 ≈ 2.102 USDC
获得的 Δx₁ = L × (1/√P - 1/√P(i_u))
          = 0.903 × (1/44.721 - 1/47.049)
          = 0.903 × (0.02236 - 0.02125) ≈ 0.00100 ETH

第二部分: 跨越上界 tick
此时价格到达上界，流动性 L 变为 0
剩余的 Δy₂ = 4985 - 2.102 = 4982.898 USDC
由于 L = 0，无法继续交换，交易部分完成
```

**最终结果：**
```javascript
交易者获得: 0.00100 ETH
交易者支付: 5000 USDC
其中手续费: 15 USDC
实际用于交换: 2.102 USDC
剩余: 5000 - 15 - 2.102 = 4982.898 USDC 未使用
```

### 4. 费用计算阶段

**更新费用累加器：**
```javascript
总手续费: 15 USDC (全部为 token0 费用)
由于 φ = 0，所有费用归 LP

每单位流动性费用增长:
Δf_g,0 = 手续费 / L = 15 / 0.903 ≈ 16.611

更新后全局状态:
f_g,0 = 0 + 16.611 = 16.611
f_g,1 = 0 (无 token1 费用)
```

### 5. 流动性移除阶段

**移除全部流动性：**
```javascript
当前价格回到区间内 (P = 2100)

步骤1: 计算未收集费用
当前 f_g,0 = 19.933
头寸记录的 f_r(t₀) = 0
未收集费用 = L × (f_g,0 - 0) = 0.903 × 19.933 ≈ 18.0 USDC

步骤2: 计算应返还的代币
当前价格在范围内，使用公式：
ΔY = ΔL · (√P - √P(i_l)) = 0.903 × (45.825 - 42.506) = 0.903 × 3.319 ≈ 3.0 ETH
ΔX = ΔL · (1/√P - 1/√P(i_u)) = 0.903 × (1/45.825 - 1/47.049)
   = 0.903 × (0.02182 - 0.02125) ≈ 0.000515

实际 USDC 数量: 0.000515 × 10⁶ = 515 USDC

步骤3: 总获得
ETH: 3.0
USDC: 515 + 18.0 (费用) = 533 USDC
```

**盈亏分析：**
```javascript
初始投入: 2 ETH + 1000 USDC
最终获得: 3 ETH + 533 USDC

盈亏:
ETH: +1.0 ETH
USDC: -467 USDC

以美元计:
初始价值: 2×2000 + 1000 = 5000 USDC
最终价值: 3×2100 + 533 = 6833 USDC
盈利: 1833 USDC (36.7% 回报)
```

## 示例2：BTC/USDT 多流动性头寸复杂交易

### 1. 初始设置

**交易对参数：**
```javascript
交易对: BTC/USDT
token0: USDT (6位小数)
token1: BTC (8位小数)
当前价格: 50,000 USDT/BTC
费率: 0.30% (γ = 0.003)
协议费率: 1/6 (φ = 1/6 ≈ 0.1667)
```

**价格与 Tick 设置：**
```javascript
当前价格: P = 50,000
当前√P: √50000 ≈ 223.6068

Tick 系统: P(i) = 1.0001^i
当前 tick: i_c = floor(log₁.₀₀₀₁(50000)) ≈ 115,129
Tick 间距: 60 (标准 0.30% 费用等级)
```

### 2. 多个流动性提供者

**LP1 - 窄区间提供者：**
```javascript
区间: [i_l, i_u] = [114,000, 116,000]
价格范围: 
  P(i_l) = 1.0001¹¹⁴⁰⁰⁰ ≈ 44,000 USDT/BTC
  P(i_u) = 1.0001¹¹⁶⁰⁰⁰ ≈ 56,818 USDT/BTC

提供: 1 BTC + 44,000 USDT
计算流动性 L₁:
  √P(i_l) ≈ 209.761, √P(i_u) ≈ 238.365, √P ≈ 223.607
  ΔL₁ = 1 / (223.607 - 209.761) ≈ 0.0722
```

**LP2 - 宽区间提供者：**
```javascript
区间: [i_l, i_u] = [112,000, 118,000]
价格范围: 
  P(i_l) = 1.0001¹¹²⁰⁰⁰ ≈ 38,720 USDT/BTC
  P(i_u) = 1.0001¹¹⁸⁰⁰⁰ ≈ 64,566 USDT/BTC

提供: 2 BTC + 77,440 USDT
计算流动性 L₂:
  √P(i_l) ≈ 196.773, √P(i_u) ≈ 254.109
  ΔL₂ = 2 / (223.607 - 196.773) ≈ 0.0745
```

**全局状态初始化：**
```javascript
总流动性: L_global = L₁ + L₂ = 0.0722 + 0.0745 = 0.1467
√P = 223.607
i_c = 115,129
f_g,0 = 0, f_g,1 = 0
```

### 3. 复杂交易过程

**大额购买交易：**
```javascript
交易者用 1,000,000 USDT 购买 BTC

步骤1: 费用计算
交易费 = 1,000,000 × 0.003 = 3,000 USDT
协议费 = 3,000 × 1/6 = 500 USDT
LP 费用 = 3,000 - 500 = 2,500 USDT
净投入 Δy = 1,000,000 - 3,000 = 997,000 USDT
```

**分段交易计算：**

**第一段：在当前价格区间内交易**
```javascript
当前流动性: L_global = 0.1467
价格移动范围: 50,000 → 56,818 (LP1 的上界)

Δ√P₁ = √56818 - √50000 = 238.365 - 223.607 = 14.758
消耗的 Δy₁ = Δ√P₁ × L_global = 14.758 × 0.1467 ≈ 2,165 USDT
获得的 Δx₁ = L_global × (1/223.607 - 1/238.365)
          = 0.1467 × (0.004472 - 0.004195) ≈ 0.0406 BTC
```

**第二段：跨越 LP1 的上界**
```javascript
跨越 tick 116,000 时:
- LP1 的流动性 L₁ = 0.0722 被移除
- 新全局流动性: L_global = L₂ = 0.0745
- 更新 tick 状态: f_o(116000) := f_g - f_o(116000)
```

**第三段：在 LP2 的区间内继续交易**
```javascript
价格移动范围: 56,818 → 64,566 (LP2 的上界)

Δ√P₂ = √64566 - √56818 = 254.109 - 238.365 = 15.744
消耗的 Δy₂ = Δ√P₂ × L_global = 15.744 × 0.0745 ≈ 1,173 USDT
获得的 Δx₂ = L_global × (1/238.365 - 1/254.109)
          = 0.0745 × (0.004195 - 0.003936) ≈ 0.0193 BTC
```

**第四段：跨越 LP2 的上界**
```javascript
跨越 tick 118,000 时:
- LP2 的流动性 L₂ = 0.0745 被移除
- 新全局流动性: L_global = 0
- 交易无法继续，因为超出所有流动性区间
```

**交易结果汇总：**
```javascript
总消耗 USDT: 2,165 + 1,173 = 3,338 USDT
总获得 BTC: 0.0406 + 0.0193 = 0.0599 BTC
剩余未使用 USDT: 997,000 - 3,338 = 993,662 USDT
平均价格: 3,338 / 0.0599 ≈ 55,726 USDT/BTC
```

### 4. 费用分配计算

**更新全局费用累加器：**
```javascript
总 LP 费用: 2,500 USDT
每单位流动性费用增长:
Δf_g,0 = 2,500 / 初始_L_global = 2,500 / 0.1467 ≈ 17,041.6
```

**计算各头寸应得费用：**

**LP1 的费用计算：**
```javascript
活跃区间: 价格从 50,000 到 56,818
费用增长计算:
f_r,LP1 = f_g - f_b(114000) - f_a(116000)

假设初始 f_o 值都为 0:
f_b(114000) = f_o(114000) = 0
f_a(116000) = f_g - f_o(116000) = 17,041.6 - 0 = 17,041.6
f_r,LP1 = 17,041.6 - 0 - 17,041.6 = 0

为什么是 0？因为 LP1 在价格超出其区间时不再累积费用。
```

**LP2 的费用计算：**
```javascript
活跃区间: 价格从 50,000 到 64,566
f_r,LP2 = f_g - f_b(112000) - f_a(118000)
        = 17,041.6 - 0 - 0 = 17,041.6

LP2 应得费用 = L₂ × f_r,LP2 = 0.0745 × 17,041.6 ≈ 1,269.6 USDT
```

**协议费用：**
```javascript
协议费用: 500 USDT
累积到 protocolFees.token0
```

### 5. 流动性移除与盈亏分析

**LP1 移除头寸：**
```javascript
当前价格: 64,566 USDT/BTC (超出 LP1 区间)

应返还代币:
由于价格高于区间，头寸完全由 token0 (USDT) 组成
ΔX = L₁ × [1/√P(i_l) - 1/√P(i_u)]
   = 0.0722 × [1/209.761 - 1/238.365]
   = 0.0722 × [0.004767 - 0.004195] ≈ 0.0413

实际 USDT: 0.0413 × 1,000,000 = 41,300 USDT

总获得: 41,300 USDT (无费用，因为价格超出区间时无费用)
初始投入: 1 BTC + 44,000 USDT
盈亏: (41,300 - 44,000) = -2,700 USDT 的净损失
```

**LP2 移除头寸：**
```javascript
当前价格: 64,566 USDT/BTC (在 LP2 区间内)

应返还代币:
ΔY = L₂ × [√P - √P(i_l)] = 0.0745 × [254.109 - 196.773] ≈ 4.272 BTC
ΔX = L₂ × [1/√P - 1/√P(i_u)] = 0.0745 × [1/254.109 - 1/254.109] = 0

总获得: 4.272 BTC + 1,269.6 USDT (费用)
初始投入: 2 BTC + 77,440 USDT

盈亏分析:
BTC: +2.272 BTC
USDT: +1,269.6 - 77,440 = -76,170.4 USDT

以 USDT 计值:
初始价值: 2×50,000 + 77,440 = 177,440 USDT
最终价值: 4.272×64,566 + 1,269.6 ≈ 276,000 USDT
盈利: 98,560 USDT (55.5% 回报)
```

## 关键数学洞察

### 流动性分布的影响
```javascript
窄区间 LP1:
- 资本效率高，但风险集中
- 价格超出区间时停止赚取费用
- 可能面临无常损失

宽区间 LP2:
- 资本效率较低，但风险分散
- 在更宽价格范围内赚取费用
- 对价格波动更具韧性
```

### 费用分配的精确性
```javascript
费用分配公式确保:
f_r = f_g - f_b(i_l) - f_a(i_u)

这保证了:
1. 只分配在头寸活跃期间产生的费用
2. 按流动性比例精确分配
3. 自动处理价格区间交叉的情况
```

### 价格影响的非线性
```javascript
交易价格影响:
区间 1 (50k→57k): 消耗 2,165 USDT，获得 0.0406 BTC
区间 2 (57k→65k): 消耗 1,173 USDT，获得 0.0193 BTC

边际价格: 2,165/0.0406 ≈ 53,325 USDT/BTC
         1,173/0.0193 ≈ 60,777 USDT/BTC

价格影响随着流动性减少而加剧
```

## 系统状态更新总结

### 交易后全局状态:
```javascript
L_global = 0 (所有流动性超出范围)
√P = 254.109 (对应 64,566 USDT/BTC)
i_c = 118,000
f_g,0 = 17,041.6
f_g,1 = 0
protocolFees.token0 = 500 USDT
```

### 各头寸状态:
```javascript
LP1: 已移除，获得 41,300 USDT
LP2: 仍在范围内，累积费用 1,269.6 USDT
```

这些例子展示了 Uniswap v3 在处理复杂交易路径时的精确计算能力，包括多个流动性头寸的协同工作、跨多个 tick 的交易执行、精确的费用分配，以及不同流动性策略的盈亏分析。